{% load static %}

<div class="dynamic-table-container" 
     data-table-id="{{ table_config.id }}"
     data-content-type="{{ content_type_id }}"
     data-api-url="{{ api_url }}"
     data-table-config="{{ table_config|safe }}">
    
    <!-- Debug information -->
    {% if debug %}
    <div class="bg-gray-100 p-4 mb-4 rounded">
        <p>Table Config ID: {{ table_config.id }}</p>
        <p>Columns: {{ table_config.columns.all|length }}</p>
        <p>API URL: {{ api_url }}</p>
    </div>
    {% endif %}
    
    <!-- Table Controls -->
    <div class="flex items-center justify-between mb-4 bg-white p-4 rounded-lg shadow-sm">
        <!-- Left Controls -->
        <div class="flex items-center space-x-4">
            <!-- View Options -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="btn-secondary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                    View
                </button>
                <div x-show="open" @click.away="open = false" 
                     class="absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                    <div class="py-1">
                        <button class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" 
                                @click="$dispatch('switch-view', 'grid')">Grid View</button>
                        <button class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" 
                                @click="$dispatch('switch-view', 'kanban')">Kanban View</button>
                        <button class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" 
                                @click="$dispatch('switch-view', 'calendar')">Calendar View</button>
                    </div>
                </div>
            </div>

            <!-- Filter Button -->
            <button class="btn-secondary" @click="$dispatch('toggle-filters')">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                Filter
            </button>

            <!-- Search -->
            <div class="relative">
                <input type="text" 
                       class="table-search form-input pl-10"
                       placeholder="Search...">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Right Controls -->
        <div class="flex items-center space-x-4">
            <!-- Column Manager -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="btn-secondary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add/Edit Columns
                </button>
                <div x-show="open" @click.away="open = false" 
                     class="absolute right-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                    <div class="p-4">
                        <div class="space-y-2" id="column-list">
                            {% for column in table_config.columns.all %}
                            <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-move" 
                                 draggable="true" 
                                 data-column-id="{{ column.id }}">
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" 
                                           class="column-toggle form-checkbox h-4 w-4 text-indigo-600"
                                           {% if column.is_visible %}checked{% endif %}
                                           data-column-id="{{ column.id }}">
                                    <span class="text-sm">{{ column.display_name }}</span>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600" 
                                        @click="$dispatch('edit-column', { id: '{{ column.id }}' })">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                    </svg>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <button @click="$dispatch('add-column')" 
                                class="mt-4 w-full btn-primary">
                            Add New Column
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="btn-secondary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export
                </button>
                <div x-show="open" @click.away="open = false" 
                     class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                    <div class="py-1">
                        <button class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" 
                                @click="$dispatch('export-data', 'csv')">Export as CSV</button>
                        <button class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" 
                                @click="$dispatch('export-data', 'excel')">Export as Excel</button>
                        <button class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left" 
                                @click="$dispatch('export-data', 'json')">Export as JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Wrapper -->
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <!-- Selection Column -->
                        <th scope="col" class="w-12 px-3 py-3.5">
                            <input type="checkbox" 
                                   class="select-all-checkbox form-checkbox h-4 w-4 text-indigo-600">
                        </th>
                        
                        <!-- Data Columns -->
                        {% for column in table_config.columns.all %}
                        {% if column.is_visible %}
                        <th scope="col" 
                            data-column-id="{{ column.id }}"
                            data-field-path="{{ column.field_path }}"
                            data-data-type="{{ column.data_type }}"
                            class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 cursor-pointer select-none">
                            <div class="flex items-center group">
                                <span>{{ column.display_name }}</span>
                                {% if column.is_sortable %}
                                <span class="sort-indicator ml-2 text-gray-400 group-hover:text-gray-600">↕️</span>
                                {% endif %}
                                <!-- Column Resize Handle -->
                                <div class="column-resize-handle absolute right-0 top-0 bottom-0 w-1 cursor-col-resize hover:bg-indigo-500"></div>
                            </div>
                        </th>
                        {% endif %}
                        {% endfor %}
                        
                        <!-- Actions Column -->
                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    <!-- Table content will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="mt-4 flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
        <div class="flex items-center space-x-4">
            <select class="page-size-select form-select">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
            <span class="text-sm text-gray-700">
                Showing <span class="font-medium">1</span> to <span class="font-medium">10</span> of <span class="font-medium">20</span> results
            </span>
        </div>
        <div class="pagination-controls">
            <!-- Pagination controls will be dynamically generated -->
        </div>
    </div>
</div>

<!-- Modals -->
{% include "shared_components/modals/column_editor.html" %}
{% include "shared_components/modals/filter_editor.html" %}
{% include "shared_components/modals/row_editor.html" %}

<!-- Styles -->
<style>
.btn-primary {
    @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
}

.btn-secondary {
    @apply inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
}

.form-input {
    @apply block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm;
}

.form-select {
    @apply block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm;
}

.form-checkbox {
    @apply rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-offset-0 focus:ring-opacity-50;
}
</style>

{% block javascript %}
<script src="{% static 'shared_components/js/dynamic-table.js' %}"></script>
{% endblock %} 