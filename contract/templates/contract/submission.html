{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Contract Renewal Application</h1>
            <p class="mt-2 text-sm text-gray-600">Please complete all required fields marked with an asterisk (*)</p>
        </div>

        <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <form id="contract-form" method="post" enctype="multipart/form-data" class="space-y-8" action="{{ request.path }}">
                {% csrf_token %}
                
                <!-- Employee Information -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Your Contract Renewal Form
                    </label>
                    <p class="text-sm text-gray-700">Welcome, {{ user.employee.get_full_name }}</p>
                    <input type="hidden" name="employee" value="{{ user.employee.id }}">
                    <p class="mt-2 text-sm text-gray-500">Your appraisal data has been automatically loaded</p>
                </div>

                <!-- Form Sections -->
                <div id="formFields" class="space-y-8">
                    <!-- Personal Details Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Personal Details</h2>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">First Name</label>
                                <input type="text" 
                                       name="first_name" 
                                       value="{{ user.employee.first_name }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Last Name</label>
                                <input type="text" 
                                       name="last_name" 
                                       value="{{ user.employee.last_name }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                            </div>

                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">IC Number</label>
                                <input type="text" 
                                       name="ic_no" 
                                       value="{{ user.employee.ic_no }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                            </div>

                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">IC Colour</label>
                                <input type="text" 
                                       name="ic_colour_display" 
                                       value="{{ user.employee.get_ic_colour_display }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                                <input type="hidden" name="ic_colour" value="{{ user.employee.ic_colour }}">
                            </div>

                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="text" 
                                       name="phone_number" 
                                       value="{{ user.employee.phone_number }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                            </div>

                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Department</label>
                                <input type="text" 
                                       name="department_display" 
                                       value="{{ user.employee.department.name }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                                <input type="hidden" name="department" class="department-id">
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Number of Past Contracts</label>
                                <input type="text" 
                                       name="contract_count" 
                                       value="{{ contract_count }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Type of Contract Applied *</label>
                                <select name="contract_type" 
                                        id="contract_type" required
                                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-800 shadow-sm">
                                    <option value="">Select contract type</option>
                                    {% for value, label in contract_type_choices %}
                                        <option value="{{ value }}"
                                                {% if form.contract_type.value == value %}selected{% endif %}
                                                {% if contract_type == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Present Post</label>
                                <input type="text" 
                                       name="present_post" 
                                       value="{{ user.employee.post }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Salary Scale/Division</label>
                                <input type="text" 
                                       name="salary_scale_division" 
                                       value="{{ user.employee.salary }}"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-gray-800 shadow-sm cursor-not-allowed opacity-80" 
                                       readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Information Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Academic Information</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Academic Qualifications</label>
                                <p class="mt-1 text-sm text-gray-500">List your academic qualifications in chronological order</p>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Degree/Diploma</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">University/College</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200" id="academicQualificationsTable">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" 
                                                id="addQualificationBtn"
                                                class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Qualification
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" name="academic_qualifications_text" id="academic_qualifications_text">
                            </div>

                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">Currently Enrolled in Higher/Professional Qualifications</label>
                                <p class="text-sm text-gray-500">Include any current studies or professional development</p>
                                <textarea name="current_enrollment" 
                                          rows="4"
                                          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-800 shadow-sm">{{ form.current_enrollment.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Research Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Research, Consultancy and Publications</h2>
                        <div class="space-y-6">
                            <!-- Consultancy Work Table -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Consultancy Work</label>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200" id="consultancyWorkTable">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title/Project</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company/Institute</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="addConsultancyBtn" class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Consultancy
                                        </button>
                                    </div>
                                    <input type="hidden" name="consultancy_work" id="consultancy_work">
                                </div>
                            </div>

                            <!-- Completed Research Table -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Completed Research</label>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200" id="researchHistoryTable">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title/Project</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funding Agency</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grants</th>
                                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="addResearchHistoryBtn" class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Research History
                                        </button>
                                    </div>
                                    <input type="hidden" name="last_research" id="last_research" value='{{ completed_research_data|default:"[]"|safe }}'>
                                </div>
                            </div>

                            <!-- Ongoing Research Table -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ongoing Research</label>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200" id="ongoingResearchTable">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title/Project</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funding Agency</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grants</th>
                                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="addOngoingResearchBtn" class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Ongoing Research
                                        </button>
                                    </div>
                                    <input type="hidden" name="ongoing_research" id="ongoing_research" value='{{ ongoing_research_data|default:"[]"|safe }}'>
                                </div>
                            </div>

                            <!-- Conference Papers Table -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Conference Papers</label>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200" id="conferencePapersTable">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volume</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pages</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOI</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="addConferencePaperBtn" class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Conference Paper
                                        </button>
                                    </div>
                                    <input type="hidden" name="conference_papers" id="conference_papers">
                                </div>
                            </div>

                            <!-- Publications Section -->
                            <div class="space-y-4">
                                <div class="flex flex-col space-y-1">
                                    <label class="text-sm font-medium text-gray-700">Publications</label>
                                    <p class="text-sm text-gray-500">Publications from your completed appraisals will be auto-populated below</p>
                                    <!-- Remove debug displays -->
                                    <div id="publications-list" class="mb-2 space-y-2"></div>
                                    <textarea name="publications" 
                                              id="publications"
                                              rows="6"
                                              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-800 shadow-sm">{{ publications_text|default:form.publications.value|default:'' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Administrative Duties Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Administrative Duties</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Attendance at Conferences, Seminars, Workshops</label>
                                <p class="mt-1 text-sm text-gray-500">List your attendance at academic events in chronological order</p>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Event Name
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Type
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Date
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Location
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Role
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Details
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200" id="conferenceAttendanceTable">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" 
                                                id="addAttendanceBtn"
                                                class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Event
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" name="attendance_data" id="attendance_data">
                            </div>
                            <!-- New Administrative Positions Held Table -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Administrative Positions Held</label>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200" id="administrativePositionsTable">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From <span class="text-red-500">*</span></th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="addAdministrativePositionBtn" class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Position
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" name="administrative_positions_text" id="administrative_positions_text">
                            </div>

                            <!-- University Committees Table -->
                            <div class="mt-6">
                                <label class="block text-sm font-medium text-gray-700">University Committees</label>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200" id="universityCommitteesTable">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-3.5 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Committee Name</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="addUniversityCommitteeBtn" class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Committee
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" name="university_committees_text" id="university_committees_text">
                            </div>

                            <!-- External Committees Table -->
                            <div class="mt-6">
                                <label class="block text-sm font-medium text-gray-700">Committees Outside the University</label>
                                <div class="mt-4">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200" id="externalCommitteesTable">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Organization</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="addExternalCommitteeBtn" class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Committee
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" name="external_committees_text" id="external_committees_text">
                            </div>
                        </div>
                    </div>

                    <!-- Other Activities Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Other Activities</h2>
                        
                        <!-- Participation Within University -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700">Participation Within University</label>
                            <p class="mt-1 text-sm text-gray-500">List your activities within the university</p>
                            <div class="mt-4">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity/Event</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role/Position</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="participationWithinTable">
                                            <!-- Rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4">
                                    <button type="button" 
                                            id="addParticipationWithinBtn"
                                            class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                        Add Activity
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" name="participation_within_text" id="participation_within_text">
                        </div>

                        <!-- Participation Outside University -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700">Participation Outside University</label>
                            <p class="mt-1 text-sm text-gray-500">List your activities outside the university</p>
                            <div class="mt-4">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity/Event</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role/Position</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="participationOutsideTable">
                                            <!-- Rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4">
                                    <button type="button" 
                                            id="addParticipationOutsideBtn"
                                            class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                        Add Activity
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" name="participation_outside_text" id="participation_outside_text">
                        </div>
                    </div>

                     <!-- Fellowships and Awards Section -->
                     <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2 pb-2 border-b">Fellowships and Awards</h2>
                        <p class="text-gray-600 mb-4">List awards, fellowships, grants, and recognitions you have received in chronological order. Include the date, title of the award, and the awarding organization.</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200" id="fellowshipsAwardsTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Organization</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4">
                            <button type="button" 
                                    id="addFellowshipAwardBtn"
                                    class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Add Fellowship/Award
                            </button>
                        </div>
                        <input type="hidden" name="fellowships_awards_text" id="fellowships_awards_text">
                    </div>

                    <!-- Teaching Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Teaching</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title of Module</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Language Medium</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No of Students</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage if Jointly Taught</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hrs Weekly</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="teachingModulesTable">
                                    <!-- Rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4">
                            <button type="button" 
                                    id="addTeachingModuleBtn"
                                    class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Add Teaching Module
                            </button>
                        </div>
                        <input type="hidden" name="teaching_modules_text" id="teaching_modules_text">

                        <!--Upload Teaching Portfolio-->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700">Teaching Portfolio</label>
                            <p class="mt-1 text-sm text-gray-500">Upload relevant documents (PDF or DOCX only)</p>
                            <div class="mt-2 flex items-center space-x-4">
                                <input type="file" 
                                       name="teaching_documents" 
                                       id="teaching_documents"
                                       accept=".pdf,.docx"
                                       class="block w-full text-sm text-gray-500
                                              file:mr-4 file:py-2 file:px-4
                                              file:rounded-md file:border-0
                                              file:text-sm file:font-semibold
                                              file:bg-indigo-50 file:text-indigo-700
                                              hover:file:bg-indigo-100">
                                {% if form.teaching_documents.value %}
                                    <span class="text-sm text-gray-500">Current file: {{ form.teaching_documents.value }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        
                        <!-- Mentorship Section (under Teaching) -->
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Mentorship</h3>
                            <p class="text-gray-600 mb-4">Document your mentorship activities for both students and staff. Include the name of the mentee, their programme (for students) or role (for staff), and the period of mentorship.</p>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200" id="mentorshipTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Programme/Description</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <!-- Rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4">
                                <button type="button" 
                                        id="addMentorshipBtn"
                                        class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add Mentorship
                                </button>
                            </div>
                            <input type="hidden" name="mentorship_text" id="mentorship_text">
                        </div>

                        <!-- Graduate Student Supervision Section (under Teaching) -->
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Supervision of Graduate Students</h3>
                            <p class="text-gray-600 mb-4">Record all post-graduate students you have supervised or are currently supervising. Include the student's name, degree programme, current status, and the period of supervision.</p>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200" id="gradSupervisionTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Programme</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <!-- Rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4">
                                <button type="button" 
                                        id="addGradSupervisionBtn"
                                        class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add Graduate Supervision
                                </button>
                            </div>
                            <input type="hidden" name="grad_supervision_text" id="grad_supervision_text">
                        </div>
                          <!-- Add Future Plan text box -->
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <label class="block text-sm font-medium text-gray-700">Future Plan</label>
                            <p class="mt-1 text-sm text-gray-500">Describe your teaching plans for the future</p>
                            <textarea name="teaching_future_plan" 
                                      id="teaching_future_plan"
                                      rows="4"
                                      class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-800 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                      >{{ form.teaching_future_plan.value|default:'' }}</textarea>
                        </div>
                    </div>

                    <!-- Achievements Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Achievements</h2>
                        <div class="space-y-6">
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">What have you achieved in the last contract for Teaching / Research / Administrative Duties?</label>
                                <textarea name="achievements_last_contract" 
                                          rows="4"
                                          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-800 shadow-sm">{{ form.achievements_last_contract.value|default:'' }}</textarea>
                            </div>

                            <div class="flex flex-col space-y-1">
                                <label class="text-sm font-medium text-gray-700">What do you propose to undertake and achieve if your contract is renewed?</label>
                                <textarea name="achievements_proposal" 
                                          rows="4"
                                          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-800 shadow-sm">{{ form.achievements_proposal.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Others Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-2 border-b">Others</h2>
                        <div class="flex flex-col space-y-1">
                            <label class="text-sm font-medium text-gray-700">Any other matters you wish to highlight?</label>
                            <textarea name="other_matters" 
                                      rows="4"
                                      class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-800 shadow-sm">{{ form.other_matters.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Debug output -->
                <div class="hidden">
                    <p>Teaching Modules Data: <span id="debug_teaching"></span></p>
                </div>

                <div class="flex justify-end mt-8 gap-4">
                    <button type="button"
                            id="save-draft-btn"
                            class="inline-flex items-center rounded-md bg-gray-50 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save as Draft
                    </button>
                    <button type="submit"
                            class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Submit Application
                    </button>
                </div>
            </form>
        </div>
        <!-- Toast Notification -->
        <div id="toast-notification" class="fixed top-4 right-4 z-50 hidden bg-green-500 text-white px-6 py-3 rounded shadow-lg transition-opacity duration-500"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const tableIds = [
        'consultancyWorkTable', 
        'researchHistoryTable', 
        'ongoingResearchTable', 
        'conferencePapersTable',
        'academicQualificationsTable',
        'conferenceAttendanceTable',
        'teachingModulesTable',
        'administrativePositionsTable',
        'universityCommitteesTable',
        'externalCommitteesTable',
        'participationWithinTable'
    ];
    
    tableIds.forEach(id => {
        const table = document.getElementById(id);
        if (table) {
            const tbody = table.querySelector('tbody');
        }
    });
    
    const formFields = document.getElementById('formFields');
    const commentsHistory = document.getElementById('appraiserCommentsHistory');
    const employeeId = document.querySelector('input[name="employee"]').value;
    const qualificationsTable = document.getElementById('academicQualificationsTable');
    const addQualificationBtn = document.getElementById('addQualificationBtn');
    const qualificationsInput = document.getElementById('academic_qualifications_text');

    // Get references to all table elements upfront to avoid issues
    const attendanceTable = document.getElementById('conferenceAttendanceTable');
    const addAttendanceBtn = document.getElementById('addAttendanceBtn');
    const attendanceInput = document.getElementById('attendance_data');

    const teachingModulesTable = document.getElementById('teachingModulesTable');
    const addTeachingModuleBtn = document.getElementById('addTeachingModuleBtn');
    const teachingModulesInput = document.getElementById('teaching_modules_text');
    
    // Add table references for research, consultancy work, etc.
    const consultancyTable = document.getElementById('consultancyWorkTable');
    const addConsultancyBtn = document.getElementById('addConsultancyBtn');
    const consultancyInput = document.getElementById('consultancy_work');
    
    const researchHistoryTable = document.getElementById('researchHistoryTable');
    const addResearchHistoryBtn = document.getElementById('addResearchHistoryBtn');
    const researchHistoryInput = document.getElementById('last_research');
    
    const ongoingResearchTable = document.getElementById('ongoingResearchTable');
    const addOngoingResearchBtn = document.getElementById('addOngoingResearchBtn');
    const ongoingResearchInput = document.getElementById('ongoing_research');
    
    const conferencePapersTable = document.getElementById('conferencePapersTable');
    const addConferencePaperBtn = document.getElementById('addConferencePaperBtn');
    const conferencePapersInput = document.getElementById('conference_papers');

    // Participation Within University
    const participationWithinTable = document.getElementById('participationWithinTable');
    const addParticipationWithinBtn = document.getElementById('addParticipationWithinBtn');
    const participationWithinInput = document.getElementById('participation_within_text');
    
    const administrativePositionsTable = document.getElementById('administrativePositionsTable');
    const addAdministrativePositionBtn = document.getElementById('addAdministrativePositionBtn');
    const administrativePositionsInput = document.getElementById('administrative_positions_text');
    
    const universityCommitteesTable = document.getElementById('universityCommitteesTable');
    const externalCommitteesTable = document.getElementById('externalCommitteesTable');
    const universityCommitteesInput = document.getElementById('university_committees_text');
    const externalCommitteesInput = document.getElementById('external_committees_text');

    // IC Color mapping
    const IC_COLOURS = {
        'Y': 'Yellow',
        'P': 'Purple',
        'G': 'Green',
        'R': 'Red'
    };

    // Add these classes to all input elements
    const commonInputClasses = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm';

    function createEditableCell(value, type = 'text') {
        const input = document.createElement('input');
        input.type = type;
        input.value = value;
        input.className = commonInputClasses;
        if (type === 'date') {
            input.required = true;
        }
        return input;
    }

    function createActionButtons(row) {
        const cell = document.createElement('td');
        cell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
        deleteBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
        `;
        deleteBtn.onclick = () => {
            row.remove();
            updateQualificationsData(); // Update after deletion
        };
        
        cell.appendChild(deleteBtn);
        return cell;
    }

    function addQualificationRow(qualification = {}) {
        const row = document.createElement('tr');
        
        // Create cells with editable inputs
        const degreeCell = document.createElement('td');
        degreeCell.className = 'px-6 py-4 whitespace-nowrap';
        const degreeInput = createEditableCell(qualification.degree_diploma || '');
        degreeInput.placeholder = 'Enter Degree/Diploma';
        degreeCell.appendChild(degreeInput);
        
        const universityCell = document.createElement('td');
        universityCell.className = 'px-6 py-4 whitespace-nowrap';
        const universityInput = createEditableCell(qualification.university_college || '');
        universityInput.placeholder = 'Enter University/College';
        universityCell.appendChild(universityInput);
        
        const fromCell = document.createElement('td');
        fromCell.className = 'px-6 py-4 whitespace-nowrap';
        const fromInput = createEditableCell(qualification.from_date || '', 'date');
        fromCell.appendChild(fromInput);
        
        const toCell = document.createElement('td');
        toCell.className = 'px-6 py-4 whitespace-nowrap';
        const toInput = createEditableCell(qualification.to_date || '', 'date');
        toCell.appendChild(toInput);
        
        // Add all cells to the row
        row.appendChild(degreeCell);
        row.appendChild(universityCell);
        row.appendChild(fromCell);
        row.appendChild(toCell);
        row.appendChild(createActionButtons(row));
        
        qualificationsTable.appendChild(row);
    }

    function createAttendanceRow(attendance = {}) {
        const row = document.createElement('tr');
        
        // Create cells with editable inputs
        const eventCell = document.createElement('td');
        eventCell.className = 'px-6 py-4 whitespace-nowrap';
        const eventInput = createEditableCell(attendance.event_name || '');
        eventInput.placeholder = 'Event Name';
        eventCell.appendChild(eventInput);
        
        const typeCell = document.createElement('td');
        typeCell.className = 'px-6 py-4 whitespace-nowrap';
        const typeSelect = document.createElement('select');
        typeSelect.className = commonInputClasses;
        ['Conference', 'Seminar', 'Workshop', 'Other'].forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            if (attendance.type === type) option.selected = true;
            typeSelect.appendChild(option);
        });
        typeCell.appendChild(typeSelect);
        
        const dateCell = document.createElement('td');
        dateCell.className = 'px-6 py-4 whitespace-nowrap';
        const dateInput = createEditableCell(attendance.date || '', 'date');
        dateInput.placeholder = 'Date';
        dateCell.appendChild(dateInput);
        
        const locationCell = document.createElement('td');
        locationCell.className = 'px-6 py-4 whitespace-nowrap';
        const locationInput = createEditableCell(attendance.location || '');
        locationInput.placeholder = 'Location';
        locationCell.appendChild(locationInput);
        
        const roleCell = document.createElement('td');
        roleCell.className = 'px-6 py-4 whitespace-nowrap';
        const roleSelect = document.createElement('select');
        roleSelect.className = commonInputClasses;
        ['Attendee', 'Presenter', 'Organizer', 'Chair', 'Other'].forEach(role => {
            const option = document.createElement('option');
            option.value = role;
            option.textContent = role;
            if (attendance.role === role) option.selected = true;
            roleSelect.appendChild(option);
        });
        roleCell.appendChild(roleSelect);
        
        const detailsCell = document.createElement('td');
        detailsCell.className = 'px-6 py-4 whitespace-nowrap';
        const detailsInput = createEditableCell(attendance.details || '', 'text');
        detailsInput.placeholder = 'Details';
        detailsCell.appendChild(detailsInput);
        
        // Add all cells to the row
        row.appendChild(eventCell);
        row.appendChild(typeCell);
        row.appendChild(dateCell);
        row.appendChild(locationCell);
        row.appendChild(roleCell);
        row.appendChild(detailsCell);
        row.appendChild(createActionButtons(row));
        
        attendanceTable.appendChild(row);
        updateAttendanceData();
    }

    function createTeachingModuleRow(data = {}) {
        const table = document.getElementById('teachingModulesTable');
        const row = document.createElement('tr');
        
        const fields = [
            { name: 'title', placeholder: 'Module Title' },
            { name: 'level', placeholder: 'Level' },
            { name: 'language', placeholder: 'Language Medium' },
            { name: 'students', placeholder: 'Number of Students', type: 'text' },
            { name: 'percentage', placeholder: 'Percentage', type: 'text' },
            { name: 'hours', placeholder: 'Hours Weekly', type: 'text' }
        ];

        fields.forEach(field => {
            const cell = document.createElement('td');
            cell.className = 'px-6 py-4 whitespace-nowrap';
            
            const input = document.createElement('input');
            input.type = field.type || 'text';
            input.className = commonInputClasses;
            input.placeholder = field.placeholder;
            input.value = data[field.name] || '';
            input.addEventListener('change', updateTeachingModulesText);
            
            cell.appendChild(input);
            row.appendChild(cell);
        });

        const actionsCell = document.createElement('td');
        actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
        
        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
        deleteButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
        `;
        deleteButton.onclick = () => {
            row.remove();
            updateTeachingModulesText();
        };
        
        actionsCell.appendChild(deleteButton);
        row.appendChild(actionsCell);
        
        table.appendChild(row);
        updateTeachingModulesText();
    }

    function updateQualificationsData() {
        const rows = qualificationsTable.getElementsByTagName('tr');
        const qualifications = [];
        
        Array.from(rows).forEach(row => {
            const inputs = row.getElementsByTagName('input');
            if (inputs.length >= 4) {
                qualifications.push({
                    degree_diploma: inputs[0].value,
                    university_college: inputs[1].value,
                    from_date: inputs[2].value,
                    to_date: inputs[3].value
                });
            }
        });
        
        qualificationsInput.value = JSON.stringify(qualifications);
    }

    function updateAttendanceData() {
        const rows = attendanceTable.getElementsByTagName('tr');
        const attendance = [];
        
        Array.from(rows).forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            if (inputs.length >= 6) {
                attendance.push({
                    event_name: inputs[0].value,
                    type: inputs[1].value,
                    date: inputs[2].value,
                    location: inputs[3].value,
                    role: inputs[4].value,
                    details: inputs[5].value
                });
            }
        });
        
        document.querySelector('input[name="attendance_data"]').value = JSON.stringify(attendance);
    }

    function updateTeachingModulesText() {
        const table = document.getElementById('teachingModulesTable');
        const modules = [];
        
        const rows = table.getElementsByTagName('tr');
        for (const row of rows) {
            const inputs = row.getElementsByTagName('input');
            if (inputs.length >= 6) {
                const moduleData = {
                    title: inputs[0].value.trim(),
                    level: inputs[1].value.trim(),
                    language: inputs[2].value.trim(),
                    students: inputs[3].value.trim(),
                    percentage: inputs[4].value.trim(),
                    hours: inputs[5].value.trim()
                };
                
                if (Object.values(moduleData).some(value => value !== '')) {
                    modules.push(moduleData);
                }
            }
        }
        
        document.getElementById('teaching_modules_text').value = JSON.stringify(modules);
    }

    // Update form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        updateAdministrativePositionsData();
        this.submit();
    });

    function updateParticipationData(tableId) {
        const table = document.getElementById(tableId);
        const inputId = tableId === 'participationWithinTable' ? 'participation_within_text' : 'participation_outside_text';
        const rows = table.getElementsByTagName('tr');
        const activities = [];
        
        Array.from(rows).forEach(row => {
            const inputs = row.getElementsByTagName('input');
            if (inputs.length >= 4) {
                activities.push({
                    activity: inputs[0].value,
                    role: inputs[1].value,
                    date: inputs[2].value,
                    remarks: inputs[3].value
                });
            }
        });
        
        document.getElementById(inputId).value = JSON.stringify(activities);
    }

    // Add event listeners for table changes
    document.getElementById('participationWithinTable').addEventListener('change', function() {
        updateParticipationData('participationWithinTable');
    });

    document.getElementById('participationOutsideTable').addEventListener('change', function() {
        updateParticipationData('participationOutsideTable');
    });

    // Add event listener for the add button
    addQualificationBtn.addEventListener('click', () => {
        addQualificationRow();
        updateQualificationsData(); // Update when adding new row
    });

    // Add event listener for qualification changes
    qualificationsTable.addEventListener('change', function(e) {
        if (e.target.tagName === 'INPUT') {
            updateQualificationsData(); // Update when any input changes
        }
    });

    // Add event listener for the add attendance button
    addAttendanceBtn.addEventListener('click', () => {
        createAttendanceRow();
    });

    // Add event listener for attendance changes
    attendanceTable.addEventListener('change', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
            updateAttendanceData();
        }
    });

    // Add event listener for the add teaching module button
    addTeachingModuleBtn.addEventListener('click', () => {
        createTeachingModuleRow();
    });

    // Function to display academic qualifications
    function displayAcademicQualifications(qualificationsText) {
        qualificationsTable.innerHTML = ''; // Clear existing rows
        
        if (!qualificationsText) return;

        try {
            const qualifications = JSON.parse(qualificationsText);
            qualifications.forEach(qual => {
                addQualificationRow(qual);
            });
            updateQualificationsData(); // Update after displaying
        } catch (e) {
            console.error('Error parsing qualifications:', e);
        }
    }

    // Function to display attendance data
    function displayAttendanceData(attendanceText) {
        attendanceTable.innerHTML = ''; // Clear existing rows
        
        if (!attendanceText) return;

        try {
            const attendance = JSON.parse(attendanceText);
            attendance.forEach(event => {
                createAttendanceRow(event);
            });
            updateAttendanceData();
        } catch (e) {
            console.error('Error parsing attendance:', e);
        }
    }

    // Load employee data immediately
    fetch(`/contract/employee-data/${employeeId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Object.keys(data.data).forEach(key => {
                    const field = document.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (key === 'ic_colour') {
                            // Set the hidden field with original value
                            field.value = data.data[key];
                            // Set the display field with full color name
                            const displayField = document.querySelector('[name="ic_colour_display"]');
                            displayField.value = IC_COLOURS[data.data[key]] || data.data[key];
                        } else if (key === 'department') {
                            // Set the display field with department name
                            const displayField = document.querySelector('[name="department_display"]');
                            displayField.value = data.data[key];
                            // Set the hidden field with department ID
                            const idField = document.querySelector('.department-id');
                            idField.value = data.data.department_id;
                        } else {
                            field.value = data.data[key] || '';
                        }
                    }
                });
                
                // Handle academic qualifications
                if (data.data.academic_qualifications_text) {
                    displayAcademicQualifications(data.data.academic_qualifications_text);
                }
                
                // Handle attendance data
                if (data.data.attendance_data) {
                    displayAttendanceData(data.data.attendance_data);
                }
                
                // Update comments history
                commentsHistory.innerHTML = ''; // Clear existing comments
                data.data.appraiser_comments_history.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'border-l-4 border-gray-200 pl-4';
                    commentDiv.innerHTML = `
                        <div class="text-sm text-gray-500 mb-2">
                            Commented by <span class="font-medium">${comment.appraiser_name}</span> on ${comment.date}
                        </div>
                        <div class="p-3 bg-gray-50 rounded-md">
                            <p class="text-gray-700">${comment.comment}</p>
                        </div>
                    `;
                    commentsHistory.appendChild(commentDiv);
                });
            }
        })
        .catch(error => console.error('Error:', error));

    // If in edit mode, load contract data from the context to populate all tables
    {% if is_edit_mode and contract_data_json %}
    const contractData = {{ contract_data_json|safe }};
    
    // Helper function to safely parse JSON that might be double-encoded
    function safelyParseJson(jsonData) {
        if (!jsonData) return [];
        
        try {
            // If it's already an object, return it
            if (typeof jsonData === 'object') return jsonData;
            
            // If it's a string, try to parse it
            const parsed = JSON.parse(jsonData);
            
            // If the parsed result is a string (might be double-encoded), parse again
            if (typeof parsed === 'string') {
                try {
                    return JSON.parse(parsed);
                } catch (e) {
                    console.error("Error parsing inner JSON string:", e);
                    return [];
                }
            }
            
            return parsed;
        } catch (e) {
            console.error("Error parsing JSON:", e);
            return [];
        }
    }
    
    // Load academic qualifications if not already loaded from employee data
    if (contractData.academic_qualifications_text) {
        displayAcademicQualifications(contractData.academic_qualifications_text);
    }
    
    // Load teaching modules data
    if (contractData.teaching_modules_text) {
        try {
            const modules = JSON.parse(contractData.teaching_modules_text);
            modules.forEach(module => createTeachingModuleRow(module));
        } catch(e) {
            console.error('Error parsing teaching modules:', e);
        }
    }
    
    // Load attendance data
    if (contractData.attendance) {
        try {
            const attendance = JSON.parse(contractData.attendance);
            attendance.forEach(event => createAttendanceRow(event));
        } catch(e) {
            console.error('Error parsing attendance data:', e);
        }
    }
    
    // Load administrative positions
    if (contractData.administrative_positions_text) {
        try {
            const positions = JSON.parse(contractData.administrative_positions_text);
            positions.forEach(position => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" value="${position.position || ''}" placeholder="Position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="date" value="${position.from_date || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="date" value="${position.to_date || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" value="${position.details || ''}" placeholder="Details" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateAdministrativePositionsData();">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                    </td>
                `;
                administrativePositionsTable.querySelector('tbody').appendChild(newRow);
            });
            updateAdministrativePositionsData();
        } catch(e) {
            console.error('Error parsing administrative positions:', e);
        }
    }
    
    // Load university committees data
    if (contractData.university_committees_text) {
        try {
            const committees = JSON.parse(contractData.university_committees_text);
            committees.forEach(committee => {
                const row = document.createElement('tr');
                
                // Add each field as a cell with an input
                ['name', 'position', 'from_date', 'to_date', 'details'].forEach(field => {
                    const cell = document.createElement('td');
                    cell.className = 'px-6 py-4 whitespace-nowrap';
                    
                    const input = document.createElement('input');
                    input.type = field.includes('date') ? 'date' : 'text';
                    input.value = committee[field] || '';
                    input.className = commonInputClasses;
                    input.placeholder = field.replace('_', ' ');
                    
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                
                // Add actions cell
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                `;
                deleteBtn.onclick = () => {
                    row.remove();
                    updateUniversityCommitteesData();
                };
                
                actionsCell.appendChild(deleteBtn);
                row.appendChild(actionsCell);
                
                universityCommitteesTable.querySelector('tbody').appendChild(row);
            });
            updateUniversityCommitteesData();
        } catch(e) {
            console.error('Error parsing university committees:', e);
        }
    }
    
    // Load external committees data
    if (contractData.external_committees_text) {
        try {
            const committees = JSON.parse(contractData.external_committees_text);
            committees.forEach(committee => {
                const row = document.createElement('tr');
                
                // Add each field as a cell with an input
                ['organization', 'position', 'from_date', 'to_date', 'details'].forEach(field => {
                    const cell = document.createElement('td');
                    cell.className = 'px-6 py-4 whitespace-nowrap';
                    
                    const input = document.createElement('input');
                    input.type = field.includes('date') ? 'date' : 'text';
                    input.value = committee[field] || '';
                    input.className = commonInputClasses;
                    input.placeholder = field.replace('_', ' ');
                    
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                
                // Add actions cell
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                `;
                deleteBtn.onclick = () => {
                    row.remove();
                    updateExternalCommitteesData();
                };
                
                actionsCell.appendChild(deleteBtn);
                row.appendChild(actionsCell);
                
                externalCommitteesTable.querySelector('tbody').appendChild(row);
            });
            updateExternalCommitteesData();
        } catch(e) {
            console.error('Error parsing external committees:', e);
        }
    }
    
    // Load participation within university
    if (contractData.participation_within_text) {
        try {
            const participations = JSON.parse(contractData.participation_within_text);
            
            // Clear the table first to prevent duplicates
            const tbody = document.getElementById('participationWithinTable').querySelector('tbody');
            while (tbody && tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            participations.forEach((participation, index) => {
                // Ensure compatibility with both field naming conventions (details or remarks)
                const data = {
                    activity: participation.activity || '',
                    role: participation.role || '',
                    date: participation.date || '',
                    remarks: participation.remarks || participation.details || '' // Use remarks if available, otherwise fall back to details
                };
                createParticipationRow('participationWithinTable', data);
            });
            updateParticipationData('participationWithinTable');
        } catch(e) {
            console.error('Error parsing participation within university:', e);
        }
    }
    
    // Load participation outside university
    if (contractData.participation_outside_text) {
        try {
            const participations = JSON.parse(contractData.participation_outside_text);
            
            // Clear the table first to prevent duplicates
            const tbody = document.getElementById('participationOutsideTable').querySelector('tbody');
            while (tbody && tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            participations.forEach((participation, index) => {
                // Ensure compatibility with both field naming conventions (details or remarks)
                const data = {
                    activity: participation.activity || '',
                    role: participation.role || '',
                    date: participation.date || '',
                    remarks: participation.remarks || participation.details || '' // Use remarks if available, otherwise fall back to details
                };
                createParticipationRow('participationOutsideTable', data);
            });
            updateParticipationData('participationOutsideTable');
        } catch(e) {
            console.error('Error parsing participation outside university:', e);
        }
    }
    
    // Load last research data
    if (contractData.last_research) {
        try {
            const researchData = safelyParseJson(contractData.last_research);
            
            if (Array.isArray(researchData)) {
                // Clear the table first to prevent any existing entries
                const tbody = researchHistoryTable.querySelector('tbody');
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                researchData.forEach((research, index) => {
                    addResearchHistoryRow(research);
                });
                updateResearchHistoryData();
            }
        } catch(e) {
            console.error('Error parsing research history data:', e);
        }
    } else {
        console.log("No research history data found");
    }
    
    // Load ongoing research data
    if (contractData.ongoing_research) {
        try {
            const researchData = safelyParseJson(contractData.ongoing_research);
            if (Array.isArray(researchData)) {
                console.log(`Found ${researchData.length} ongoing research items to load`);
                // Clear the table first to prevent any existing entries
                const tbody = ongoingResearchTable.querySelector('tbody');
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                researchData.forEach((research, index) => {
                    console.log(`Processing ongoing research item ${index}:`, research);
                    addOngoingResearchRow(research);
                });
                updateOngoingResearchData();
            }
        } catch(e) {
            console.error('Error parsing ongoing research data:', e);
        }
    } else {
        console.log("No ongoing research data found");
    }
    
    // Load consultancy work data
    if (contractData.consultancy_work) {
        try {
            console.log("Loading consultancy work data:", contractData.consultancy_work);
            const consultancyData = safelyParseJson(contractData.consultancy_work);
            console.log("Parsed consultancy data:", consultancyData);
            
            if (Array.isArray(consultancyData)) {
                console.log(`Found ${consultancyData.length} consultancy work items to load`);
                consultancyData.forEach((consultancy, index) => {
                    console.log(`Processing consultancy item ${index}:`, consultancy);
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${consultancy.title || ''}" placeholder="Enter Title/Project" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${consultancy.company || ''}" placeholder="Enter Company/Institute" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="date" value="${consultancy.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="date" value="${consultancy.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateConsultancyData();">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </td>
                    `;
                    
                    if (consultancyTable && consultancyTable.querySelector('tbody')) {
                        consultancyTable.querySelector('tbody').appendChild(newRow);
                    } else {
                        console.error("Cannot find consultancy table tbody:", consultancyTable);
                    }
                });
                updateConsultancyData();
            }
        } catch(e) {
            console.error('Error parsing consultancy work data:', e);
        }
    } else {
        console.log("No consultancy work data found");
    }
    
    // Load research history data
    if (contractData.last_research) {
        try {
            console.log("Loading research history data:", contractData.last_research);
            const researchData = safelyParseJson(contractData.last_research);
            console.log("Parsed research history data:", researchData);
            
            if (Array.isArray(researchData)) {
                console.log(`Found ${researchData.length} research history items to load`);
                // Clear the table first to prevent any existing entries
                const tbody = researchHistoryTable.querySelector('tbody');
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                researchData.forEach((research, index) => {
                    console.log(`Processing research history item ${index}:`, research);
                    addResearchHistoryRow(research);
                });
                updateResearchHistoryData();
            }
        } catch(e) {
            console.error('Error parsing research history data:', e);
        }
    } else {
        console.log("No research history data found");
    }
    
    // Load ongoing research data
    if (contractData.ongoing_research) {
        try {
            console.log("Loading ongoing research data:", contractData.ongoing_research);
            const researchData = safelyParseJson(contractData.ongoing_research);
            console.log("Parsed ongoing research data:", researchData);
            
            if (Array.isArray(researchData)) {
                console.log(`Found ${researchData.length} ongoing research items to load`);
                // Clear the table first to prevent any existing entries
                const tbody = ongoingResearchTable.querySelector('tbody');
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                researchData.forEach((research, index) => {
                    console.log(`Processing ongoing research item ${index}:`, research);
                    addOngoingResearchRow(research);
                });
                updateOngoingResearchData();
            }
        } catch(e) {
            console.error('Error parsing ongoing research data:', e);
        }
    } else {
        console.log("No ongoing research data found");
    }
    
    // Load conference papers data
    if (contractData.conference_papers) {
        try {
            console.log("Loading conference papers data:", contractData.conference_papers);
            const papersData = safelyParseJson(contractData.conference_papers);
            console.log("Parsed conference papers data:", papersData);
            
            if (Array.isArray(papersData)) {
                console.log(`Found ${papersData.length} conference papers items to load`);
                papersData.forEach((paper, index) => {
                    console.log(`Processing conference paper item ${index}:`, paper);
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${paper.author || ''}" placeholder="Enter Author" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${paper.year || ''}" placeholder="Enter Year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${paper.title || ''}" placeholder="Enter Title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${paper.volume || ''}" placeholder="Enter Volume" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${paper.pages || ''}" placeholder="Enter Pages" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${paper.doi || ''}" placeholder="Enter DOI" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateConferencePapersData();">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </td>
                    `;
                    if (conferencePapersTable && conferencePapersTable.querySelector('tbody')) {
                        conferencePapersTable.querySelector('tbody').appendChild(newRow);
                    } else {
                        console.error("Cannot find conference papers table tbody:", conferencePapersTable);
                    }
                });
                updateConferencePapersData();
            }
        } catch(e) {
            console.error('Error parsing conference papers data:', e);
        }
    } else {
        console.log("No conference papers data found");
    }
    
    // Load fellowships and awards data
    if (contractData.fellowships_awards_text) {
        try {
            console.log("Loading fellowships and awards data:", contractData.fellowships_awards_text);
            const awardsData = safelyParseJson(contractData.fellowships_awards_text);
            console.log("Parsed fellowships and awards data:", awardsData);
            
            if (Array.isArray(awardsData)) {
                console.log(`Found ${awardsData.length} fellowships and awards to load`);
                // Clear the table first to prevent any existing entries
                const tbody = fellowshipsAwardsTable.querySelector('tbody');
                while (tbody && tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                awardsData.forEach((award, index) => {
                    console.log(`Processing fellowship/award item ${index}:`, award);
                    addFellowshipAwardRow(award);
                });
                updateFellowshipsAwardsData();
            }
        } catch(e) {
            console.error('Error parsing fellowships and awards data:', e);
        }
    } else {
        console.log("No fellowships and awards data found");
    }
    
    // Load mentorship data
    if (contractData.mentorship_text) {
        try {
            console.log("Loading mentorship data:", contractData.mentorship_text);
            const mentorshipData = safelyParseJson(contractData.mentorship_text);
            console.log("Parsed mentorship data:", mentorshipData);
            
            if (Array.isArray(mentorshipData)) {
                console.log(`Found ${mentorshipData.length} mentorship entries to load`);
                // Clear the table first to prevent any existing entries
                const tbody = mentorshipTable.querySelector('tbody');
                while (tbody && tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                mentorshipData.forEach((mentorship, index) => {
                    console.log(`Processing mentorship item ${index}:`, mentorship);
                    addMentorshipRow(mentorship);
                });
                updateMentorshipData();
            }
        } catch(e) {
            console.error('Error parsing mentorship data:', e);
        }
    } else {
        console.log("No mentorship data found");
    }
    
    // Load graduate supervision data
    if (contractData.grad_supervision_text) {
        try {
            console.log("Loading graduate supervision data:", contractData.grad_supervision_text);
            const supervisionData = safelyParseJson(contractData.grad_supervision_text);
            console.log("Parsed graduate supervision data:", supervisionData);
            
            if (Array.isArray(supervisionData)) {
                console.log(`Found ${supervisionData.length} graduate supervision entries to load`);
                // Clear the table first to prevent any existing entries
                const tbody = gradSupervisionTable.querySelector('tbody');
                while (tbody && tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                supervisionData.forEach((supervision, index) => {
                    console.log(`Processing graduate supervision item ${index}:`, supervision);
                    addGradSupervisionRow(supervision);
                });
                updateGradSupervisionData();
            }
        } catch(e) {
            console.error('Error parsing graduate supervision data:', e);
        }
    } else {
        console.log("No graduate supervision data found");
    }
    
    {% endif %}

    // Initialize publications if they exist
    const existingPublications = document.getElementById('publications').value;
    if (existingPublications) {
        try {
            // Check if it's JSON format (from older versions)
            JSON.parse(existingPublications);
            // If no error, it's in JSON format - keep as is
        } catch (e) {
            // Not JSON, it's already text format - keep as is
        }
    }

    // Display existing teaching modules if any
    {% if not is_edit_mode %}
    if (teachingModulesInput.value) {
        try {
            const modules = JSON.parse(teachingModulesInput.value);
            modules.forEach(module => createTeachingModuleRow(module));
        } catch (e) {
            console.error('Error parsing teaching modules:', e);
        }
    }
    {% endif %}

    function createParticipationRow(tableId, data = {}) {
        const table = document.getElementById(tableId);
        const row = document.createElement('tr');
        
        const fields = [
            { name: 'activity', placeholder: 'Activity/Event' },
            { name: 'role', placeholder: 'Role/Position' },
            { name: 'date', placeholder: 'Date', type: 'date' },
            { name: 'remarks', placeholder: 'Remarks' }
        ];

        fields.forEach(field => {
            const cell = document.createElement('td');
            cell.className = 'px-6 py-4 whitespace-nowrap';
            
            const input = document.createElement('input');
            input.type = field.type || 'text';
            input.className = commonInputClasses;
            input.placeholder = field.placeholder;
            input.value = data[field.name] || '';
            
            cell.appendChild(input);
            row.appendChild(cell);
        });

        // Add action buttons
        const actionsCell = document.createElement('td');
        actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
        
        const deleteButton = document.createElement('button');
        deleteButton.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
        deleteButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
        `;
        deleteButton.onclick = () => {
            row.remove();
            updateParticipationData(tableId);
        };
        
        actionsCell.appendChild(deleteButton);
        row.appendChild(actionsCell);
        
        table.appendChild(row);
        updateParticipationData(tableId);
    }

    // Add event listeners
    addParticipationWithinBtn.addEventListener('click', () => {
        createParticipationRow('participationWithinTable');
    });

    addParticipationOutsideBtn.addEventListener('click', () => {
        createParticipationRow('participationOutsideTable');
    });

    // Initialize existing data if any
    {% if not is_edit_mode %}
    // Only initialize from local data if NOT in edit mode (otherwise it comes from contractData)
    if (participationWithinInput.value) {
        try {
            const activities = JSON.parse(participationWithinInput.value);
            activities.forEach(activity => createParticipationRow('participationWithinTable', activity));
        } catch (e) {
            console.error('Error parsing participation within:', e);
        }
    }

    if (document.getElementById('participation_outside_text').value) {
        try {
            const activities = JSON.parse(document.getElementById('participation_outside_text').value);
            activities.forEach(activity => createParticipationRow('participationOutsideTable', activity));
        } catch (e) {
            console.error('Error parsing participation outside:', e);
        }
    }
    {% endif %}

    addAdministrativePositionBtn.addEventListener('click', function() {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Enter Position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                       pattern="\d{4}-\d{2}-\d{2}"
                       placeholder="YYYY-MM-DD"
                       required>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                       pattern="\d{4}-\d{2}-\d{2}"
                       placeholder="YYYY-MM-DD">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Details" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateAdministrativePositionsData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;

        administrativePositionsTable.querySelector('tbody').appendChild(row);
        updateAdministrativePositionsData();
    });

    // Function to collect administrative positions data
    function updateAdministrativePositionsData() {
        const positions = [];
        const rows = administrativePositionsTable.querySelectorAll('tbody tr');


        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input');
            console.log(`Debug: Row ${index + 1} inputs:`, {
                position: inputs[0].value,
                from_date: inputs[1].value,
                to_date: inputs[2].value,
                details: inputs[3].value
            });

            const position = inputs[0].value;
            const fromDate = inputs[1].value;
            const toDate = inputs[2].value;
            const details = inputs[3].value;

            // Only add positions with a valid from_date
            if (fromDate && fromDate.trim() !== '') {
                positions.push({
                    position: position || '',
                    from_date: fromDate,
                    to_date: toDate || fromDate, // Use from_date as fallback if to_date is empty
                    details: details || ''
                });
            } else {
                console.warn(`Skipping row ${index + 1} due to missing from_date`);
                // Highlight the empty date field in red
                inputs[1].classList.add('border-red-500');
            }
        });
        
        administrativePositionsInput.value = JSON.stringify(positions);
        return positions.length;
    }

    // Also update when table changes
    administrativePositionsTable.addEventListener('change', function(e) {
        // Remove error highlighting when field is filled
        if (e.target.tagName === 'INPUT' && e.target.type === 'date') {
            if (e.target.value && e.target.value.trim() !== '') {
                e.target.classList.remove('border-red-500');
            }
        }
        updateAdministrativePositionsData();
    });
    
    // Add form validation before submission
    document.querySelector('form').addEventListener('submit', function(e) {
        // Update all dynamic data tables
        updateAdministrativePositionsData();
        updateUniversityCommitteesData();
        updateExternalCommitteesData();
        // Add any other data table update functions here
        
        // Check if all required date fields are filled
        const dateInputs = administrativePositionsTable.querySelectorAll('tbody tr input[type="date"]:first-of-type');
        let hasEmptyDates = false;
        
        dateInputs.forEach(input => {
            if (!input.value || input.value.trim() === '') {
                input.classList.add('border-red-500');
                hasEmptyDates = true;
            }
        });
        
        if (hasEmptyDates) {
            e.preventDefault();
            alert('Please fill in all required date fields for Administrative Positions. The "From" date is required.');
            // Scroll to the administrative positions section
            administrativePositionsTable.scrollIntoView({ behavior: 'smooth' });
        }
    });

    // Function to create a new row for University Committees
    function createUniversityCommitteeRow(committee = {}) {
        const row = document.createElement('tr');
        
        const cells = [
            { placeholder: 'Committee Name', value: committee.name || '', type: 'text' },
            { placeholder: 'Position', value: committee.position || '', type: 'text' },
            { placeholder: 'From', value: committee.from_date || '', type: 'date' },
            { placeholder: 'To', value: committee.to_date || '', type: 'date' },
            { placeholder: 'Details', value: committee.details || '', type: 'text' }
        ];

        cells.forEach(cell => {
            const td = document.createElement('td');
            td.className = 'px-6 py-4 whitespace-nowrap';
            
            const input = document.createElement('input');
            input.type = cell.type;
            input.value = cell.value;
            input.placeholder = cell.placeholder;
            input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm';
            
            td.appendChild(input);
            row.appendChild(td);
        });

        // Add action buttons cell
        const actionsCell = document.createElement('td');
        actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
        deleteBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
        `;
        deleteBtn.onclick = () => {
            row.remove();
            updateUniversityCommitteesData();
        };
        
        actionsCell.appendChild(deleteBtn);
        row.appendChild(actionsCell);

        universityCommitteesTable.querySelector('tbody').appendChild(row);
        updateUniversityCommitteesData();
    }

    // Function to create a new row for External Committees
    function createExternalCommitteeRow(committee = {}) {
        const row = document.createElement('tr');
        
        const cells = [
            { placeholder: 'Organization', value: committee.organization || '', type: 'text' },
            { placeholder: 'Position', value: committee.position || '', type: 'text' },
            { placeholder: 'From', value: committee.from_date || '', type: 'date' },
            { placeholder: 'To', value: committee.to_date || '', type: 'date' },
            { placeholder: 'Details', value: committee.details || '', type: 'text' }
        ];

        cells.forEach(cell => {
            const td = document.createElement('td');
            td.className = 'px-6 py-4 whitespace-nowrap';
            
            const input = document.createElement('input');
            input.type = cell.type;
            input.value = cell.value;
            input.placeholder = cell.placeholder;
            input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm';
            
            td.appendChild(input);
            row.appendChild(td);
        });

        // Add action buttons cell
        const actionsCell = document.createElement('td');
        actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
        deleteBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
        `;
        deleteBtn.onclick = () => {
            row.remove();
            updateExternalCommitteesData();
        };
        
        actionsCell.appendChild(deleteBtn);
        row.appendChild(actionsCell);

        externalCommitteesTable.querySelector('tbody').appendChild(row);
        updateExternalCommitteesData();
    }

    // Function to update the hidden input for University Committees
    function updateUniversityCommitteesData() {
        const committees = [];
        universityCommitteesTable.querySelectorAll('tbody tr').forEach(row => {
            const inputs = row.querySelectorAll('input');
            const committee = {
                name: inputs[0].value.trim(),
                position: inputs[1].value.trim(),
                from_date: inputs[2].value.trim(),
                to_date: inputs[3].value.trim(),
                details: inputs[4].value.trim()
            };
            
            // Only add if at least one field has data
            if (Object.values(committee).some(value => value !== '')) {
                committees.push(committee);
            }
        });
        universityCommitteesInput.value = JSON.stringify(committees);
    }

    // Function to update the hidden input for External Committees
    function updateExternalCommitteesData() {
        const committees = [];
        externalCommitteesTable.querySelectorAll('tbody tr').forEach(row => {
            const inputs = row.querySelectorAll('input');
            const committee = {
                organization: inputs[0].value.trim(),
                position: inputs[1].value.trim(),
                from_date: inputs[2].value.trim(),
                to_date: inputs[3].value.trim(),
                details: inputs[4].value.trim()
            };
            
            // Only add if at least one field has data
            if (Object.values(committee).some(value => value !== '')) {
                committees.push(committee);
            }
        });
        externalCommitteesInput.value = JSON.stringify(committees);
    }

    // Event listeners for adding new rows
    document.getElementById('addUniversityCommitteeBtn').addEventListener('click', () => {
        createUniversityCommitteeRow();
    });

    document.getElementById('addExternalCommitteeBtn').addEventListener('click', () => {
        createExternalCommitteeRow();
    });

    // Add event listeners for input changes
    document.getElementById('universityCommitteesTable').addEventListener('input', function() {
        updateUniversityCommitteesData();
    });

    document.getElementById('externalCommitteesTable').addEventListener('input', function() {
        updateExternalCommitteesData();
    });

    // Initialize university committees if there's existing data
    {% if not is_edit_mode %}
    if (universityCommitteesInput.value) {
        try {
            const committees = JSON.parse(universityCommitteesInput.value);
            committees.forEach(committee => createUniversityCommitteeRow(committee));
        } catch (e) {
            console.error('Error parsing university committees:', e);
        }
    }

    if (externalCommitteesInput.value) {
        try {
            const committees = JSON.parse(externalCommitteesInput.value);
            committees.forEach(committee => createExternalCommitteeRow(committee));
        } catch (e) {
            console.error('Error parsing external committees:', e);
        }
    }
    {% endif %}

    // Consultancy Work Table
    function addConsultancyRow(data = {}) {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.title || ''}" placeholder="Enter Title/Project" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.company || ''}" placeholder="Enter Company/Institute" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateConsultancyData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;
        consultancyTable.querySelector('tbody').appendChild(newRow);
    }

    function updateConsultancyData() {
        const rows = consultancyTable.querySelectorAll('tbody tr');
        const data = Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input');
            return {
                title: inputs[0].value,
                company: inputs[1].value,
                startDate: inputs[2].value,
                endDate: inputs[3].value
            };
        });
        consultancyInput.value = JSON.stringify(data);
    }

    addConsultancyBtn.addEventListener('click', addConsultancyRow);
    consultancyTable.addEventListener('change', updateConsultancyData);

    // Research History Table
    function addResearchHistoryRow(data = {}) {
        // Skip adding duplicate rows
        if (data.title) {
            const existingRows = researchHistoryTable.querySelectorAll('tbody tr');
            let isDuplicate = false;
            
            existingRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value === data.title && 
                    inputs[1].value === data.startDate && 
                    inputs[2].value === data.endDate && 
                    inputs[3].value === data.fundingAgency &&
                    inputs[4].value === data.grants) {
                    isDuplicate = true;
                }
            });
            
            if (isDuplicate) {
                console.log(`Skipping duplicate research history item: ${data.title}`);
                return;
            }
        }
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.title || ''}" placeholder="Enter Title/Project" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.fundingAgency || ''}" placeholder="Enter Funding Agency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.grants || ''}" placeholder="Enter Grant Amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateResearchHistoryData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;
        researchHistoryTable.querySelector('tbody').appendChild(newRow);
    }

    function updateResearchHistoryData() {
        const rows = researchHistoryTable.querySelectorAll('tbody tr');
        const researchHistory = Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input');
            return {
                title: inputs[0].value,
                startDate: inputs[1].value,
                endDate: inputs[2].value,
                fundingAgency: inputs[3].value,
                grants: inputs[4].value
            };
        });
        researchHistoryInput.value = JSON.stringify(researchHistory);
    }

    addResearchHistoryBtn.addEventListener('click', () => addResearchHistoryRow({}));
    researchHistoryTable.addEventListener('change', updateResearchHistoryData);

    // Ongoing Research Table
    function addOngoingResearchRow(data = {}) {
        // Skip adding duplicate rows
        if (data.title) {
            const existingRows = ongoingResearchTable.querySelectorAll('tbody tr');
            let isDuplicate = false;
            
            existingRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value === data.title && 
                    inputs[1].value === data.startDate && 
                    inputs[2].value === data.endDate && 
                    inputs[3].value === data.fundingAgency &&
                    inputs[4].value === data.grants) {
                    isDuplicate = true;
                }
            });
            
            if (isDuplicate) {
                console.log(`Skipping duplicate ongoing research item: ${data.title}`);
                return;
            }
        }
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.title || ''}" placeholder="Enter Title/Project" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.fundingAgency || ''}" placeholder="Enter Funding Agency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.grants || ''}" placeholder="Enter Grant Amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateOngoingResearchData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;
        ongoingResearchTable.querySelector('tbody').appendChild(newRow);
    }

    function updateOngoingResearchData() {
        const rows = ongoingResearchTable.querySelectorAll('tbody tr');
        const ongoingResearch = Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input');
            return {
                title: inputs[0].value,
                startDate: inputs[1].value,
                endDate: inputs[2].value,
                fundingAgency: inputs[3].value,
                grants: inputs[4].value
            };
        });
        ongoingResearchInput.value = JSON.stringify(ongoingResearch);
    }

    addOngoingResearchBtn.addEventListener('click', () => addOngoingResearchRow({}));
    ongoingResearchTable.addEventListener('change', updateOngoingResearchData);

    // Conference Papers Table
    function addConferencePaperRow() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Enter Author" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Enter Year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Enter Title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Enter Volume" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Enter Pages" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" placeholder="Enter DOI" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateConferencePapersData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;
        conferencePapersTable.querySelector('tbody').appendChild(newRow);
    }

    function updateConferencePapersData() {
        const rows = conferencePapersTable.querySelectorAll('tbody tr');
        const data = Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input');
            return {
                author: inputs[0].value,
                year: inputs[1].value,
                title: inputs[2].value,
                volume: inputs[3].value,
                pages: inputs[4].value,
                doi: inputs[5].value
            };
        });
        conferencePapersInput.value = JSON.stringify(data);
    }

    addConferencePaperBtn.addEventListener('click', addConferencePaperRow);
    conferencePapersTable.addEventListener('change', updateConferencePapersData);

    // Initialize dynamic tables if there's existing data
    {% if not is_edit_mode %}
    
    if (consultancyInput.value && consultancyInput.value !== 'null') {
        try {
            console.log("Initializing consultancy from local value:", consultancyInput.value);
            const consultancyData = JSON.parse(consultancyInput.value);
            if (Array.isArray(consultancyData)) {
                consultancyData.forEach(item => addConsultancyRow(item));
            }
        } catch (e) {
            console.error('Error parsing consultancy data:', e);
        }
    }
    
    if (researchHistoryInput.value && researchHistoryInput.value !== 'null') {
        try {
            const researchData = JSON.parse(researchHistoryInput.value);
            if (Array.isArray(researchData)) {
                researchData.forEach(item => addResearchHistoryRow(item));
                updateResearchHistoryData();
            }
        } catch (e) {
            console.error('Error parsing research history data:', e);
        }
    }
    
    if (ongoingResearchInput.value && ongoingResearchInput.value !== 'null') {
        try {
            const researchData = JSON.parse(ongoingResearchInput.value);
            if (Array.isArray(researchData)) {
                researchData.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.title || ''}" placeholder="Enter Title/Project" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="date" value="${item.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="date" value="${item.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.fundingAgency || ''}" placeholder="Enter Funding Agency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.grants || ''}" placeholder="Enter Grant Amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateOngoingResearchData();">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </td>
                    `;
                    ongoingResearchTable.querySelector('tbody').appendChild(newRow);
                });
                updateOngoingResearchData();
            }
        } catch (e) {
            console.error('Error parsing ongoing research data:', e);
        }
    }
    
    if (conferencePapersInput.value && conferencePapersInput.value !== 'null') {
        try {
            console.log("Initializing conference papers from local value:", conferencePapersInput.value);
            const papersData = JSON.parse(conferencePapersInput.value);
            if (Array.isArray(papersData)) {
                papersData.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.author || ''}" placeholder="Enter Author" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.year || ''}" placeholder="Enter Year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.title || ''}" placeholder="Enter Title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.volume || ''}" placeholder="Enter Volume" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.pages || ''}" placeholder="Enter Pages" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" value="${item.doi || ''}" placeholder="Enter DOI" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateConferencePapersData();">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </td>
                    `;
                    conferencePapersTable.querySelector('tbody').appendChild(newRow);
                });
                updateConferencePapersData();
            }
        } catch (e) {
            console.error('Error parsing conference papers data:', e);
        }
    }
    {% endif %}

    // Fellowships and Awards Table
    const fellowshipsAwardsTable = document.getElementById('fellowshipsAwardsTable');
    const addFellowshipAwardBtn = document.getElementById('addFellowshipAwardBtn');
    const fellowshipsAwardsInput = document.getElementById('fellowships_awards_text');

    function addFellowshipAwardRow(data = {}) {
        // Skip adding duplicate rows
        if (data.title) {
            const existingRows = fellowshipsAwardsTable.querySelectorAll('tbody tr');
            let isDuplicate = false;
            
            existingRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value === data.date && 
                    inputs[1].value === data.title && 
                    inputs[2].value === data.organization) {
                    isDuplicate = true;
                }
            });
            
            if (isDuplicate) {
                console.log(`Skipping duplicate fellowship/award: ${data.title}`);
                return;
            }
        }
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.date || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.title || ''}" placeholder="Enter Title/Award Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.organization || ''}" placeholder="Enter Awarding Organization" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateFellowshipsAwardsData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;
        fellowshipsAwardsTable.querySelector('tbody').appendChild(newRow);
        updateFellowshipsAwardsData();
    }

    function updateFellowshipsAwardsData() {
        const rows = fellowshipsAwardsTable.querySelectorAll('tbody tr');
        const data = Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input');
            return {
                date: inputs[0].value,
                title: inputs[1].value,
                organization: inputs[2].value
            };
        });
        fellowshipsAwardsInput.value = JSON.stringify(data);
    }

    addFellowshipAwardBtn.addEventListener('click', () => addFellowshipAwardRow({}));
    fellowshipsAwardsTable.addEventListener('change', updateFellowshipsAwardsData);

    // Mentorship Table
    const mentorshipTable = document.getElementById('mentorshipTable');
    const addMentorshipBtn = document.getElementById('addMentorshipBtn');
    const mentorshipInput = document.getElementById('mentorship_text');

    function addMentorshipRow(data = {}) {
        // Skip adding duplicate rows
        if (data.name) {
            const existingRows = mentorshipTable.querySelectorAll('tbody tr');
            let isDuplicate = false;
            
            existingRows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                if (inputs[0].value === data.name && 
                    inputs[1].value === data.type && 
                    inputs[2].value === data.programme &&
                    inputs[3].value === data.startDate &&
                    inputs[4].value === data.endDate) {
                    isDuplicate = true;
                }
            });
            
            if (isDuplicate) {
                console.log(`Skipping duplicate mentorship: ${data.name}`);
                return;
            }
        }
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.name || ''}" placeholder="Enter Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="Student" ${data.type === 'Student' ? 'selected' : ''}>Student</option>
                    <option value="Staff" ${data.type === 'Staff' ? 'selected' : ''}>Staff</option>
                </select>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.programme || ''}" placeholder="Enter Programme/Description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateMentorshipData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;
        mentorshipTable.querySelector('tbody').appendChild(newRow);
        updateMentorshipData();
    }

    function updateMentorshipData() {
        const rows = mentorshipTable.querySelectorAll('tbody tr');
        const data = Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input, select');
            return {
                name: inputs[0].value,
                type: inputs[1].value,
                programme: inputs[2].value,
                startDate: inputs[3].value,
                endDate: inputs[4].value
            };
        });
        mentorshipInput.value = JSON.stringify(data);
        console.log('Updated mentorship data:', mentorshipInput.value);
    }

    addMentorshipBtn.addEventListener('click', () => addMentorshipRow({}));
    mentorshipTable.addEventListener('change', updateMentorshipData);

    // Graduate Student Supervision Table
    const gradSupervisionTable = document.getElementById('gradSupervisionTable');
    const addGradSupervisionBtn = document.getElementById('addGradSupervisionBtn');
    const gradSupervisionInput = document.getElementById('grad_supervision_text');

    function addGradSupervisionRow(data = {}) {
        // Skip adding duplicate rows
        if (data.name) {
            const existingRows = gradSupervisionTable.querySelectorAll('tbody tr');
            let isDuplicate = false;
            
            existingRows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                if (inputs[0].value === data.name && 
                    inputs[1].value === data.programme && 
                    inputs[2].value === data.status &&
                    inputs[3].value === data.startDate &&
                    inputs[4].value === data.endDate) {
                    isDuplicate = true;
                }
            });
            
            if (isDuplicate) {
                console.log(`Skipping duplicate graduate supervision: ${data.name}`);
                return;
            }
        }
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.name || ''}" placeholder="Enter Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="text" value="${data.programme || ''}" placeholder="Enter Programme" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="Active" ${data.status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Inactive" ${data.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                </select>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="date" value="${data.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateGradSupervisionData();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </td>
        `;
        gradSupervisionTable.querySelector('tbody').appendChild(newRow);
        updateGradSupervisionData();
    }

    function updateGradSupervisionData() {
        const rows = gradSupervisionTable.querySelectorAll('tbody tr');
        const data = Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input, select');
            return {
                name: inputs[0].value,
                programme: inputs[1].value,
                status: inputs[2].value,
                startDate: inputs[3].value,
                endDate: inputs[4].value
            };
        });
        gradSupervisionInput.value = JSON.stringify(data);
        console.log('Updated graduate supervision data:', gradSupervisionInput.value);
    }

    addGradSupervisionBtn.addEventListener('click', () => addGradSupervisionRow({}));
    gradSupervisionTable.addEventListener('change', updateGradSupervisionData);

    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.className = 'fixed top-4 right-4 z-50 px-6 py-3 rounded shadow-lg transition-opacity duration-500 ' +
            (isSuccess ? 'bg-green-500' : 'bg-red-500') + ' text-white';
        toast.style.opacity = '1';
        toast.classList.remove('hidden');
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 500);
        }, 2500);
    }

    document.getElementById('save-draft-btn').addEventListener('click', function() {
        // --- Update all dynamic tables and hidden fields before collecting FormData ---
        if (typeof updateAcademicQualifications === 'function') updateAcademicQualifications();
        if (typeof updateConsultancyWorkData === 'function') updateConsultancyWorkData();
        if (typeof updateResearchHistoryData === 'function') updateResearchHistoryData();
        if (typeof updateOngoingResearchData === 'function') updateOngoingResearchData();
        if (typeof updateConferencePapersData === 'function') updateConferencePapersData();
        if (typeof updateAttendanceData === 'function') updateAttendanceData();
        if (typeof updateAdministrativePositionsData === 'function') updateAdministrativePositionsData();
        if (typeof updateUniversityCommitteesData === 'function') updateUniversityCommitteesData();
        if (typeof updateExternalCommitteesData === 'function') updateExternalCommitteesData();
        if (typeof updateTeachingModulesText === 'function') updateTeachingModulesText();
        if (typeof updateFellowshipsAwardsData === 'function') updateFellowshipsAwardsData();
        if (typeof updateMentorshipData === 'function') updateMentorshipData();
        if (typeof updateGradSupervisionData === 'function') updateGradSupervisionData();

        // Use the form by id to ensure correct form is used
        const form = document.getElementById('contract-form');
        const formData = new FormData(form);
        formData.set('is_draft', 'true');
        fetch(window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Draft saved.', true);
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/contract/employee_contracts/';
                }, 1200);
            } else {
                showToast('Failed to save draft.', false);
            }
        })
        .catch(() => showToast('Error saving draft.', false));
    });

    // Populate Mentorship table from contractData
    if (typeof contractData !== 'undefined' && contractData.mentorship_text) {
        try {
            const mentorships = JSON.parse(contractData.mentorship_text);
            mentorships.forEach(m => {
                if (typeof createMentorshipRow === 'function') createMentorshipRow(m);
            });
        } catch(e) {
            console.error('Error parsing mentorship_text:', e);
        }
    }
    // Populate Graduate Supervision table from contractData
    if (typeof contractData !== 'undefined' && contractData.grad_supervision_text) {
        try {
            const gradSupervisions = JSON.parse(contractData.grad_supervision_text);
            gradSupervisions.forEach(g => {
                if (typeof createGradSupervisionRow === 'function') createGradSupervisionRow(g);
            });
        } catch(e) {
            console.error('Error parsing grad_supervision_text:', e);
        }
    }
    // Populate Fellowships and Awards table from contractData
    if (typeof contractData !== 'undefined' && contractData.fellowships_awards_text) {
        try {
            const fellowships = JSON.parse(contractData.fellowships_awards_text);
            fellowships.forEach(f => {
                if (typeof createFellowshipAwardRow === 'function') createFellowshipAwardRow(f);
            });
        } catch(e) {
            console.error('Error parsing fellowships_awards_text:', e);
        }
    }

    // Direct initialization from context variable for academic qualifications
    {% if academic_qualifications_text and not is_edit_mode  %}
    try {
        const academicQualifications = JSON.parse('{{ academic_qualifications_text|escapejs }}');
        if (Array.isArray(academicQualifications)) {
            academicQualifications.forEach(qual => {
                addQualificationRow(qual);
            });
            updateQualificationsData();
        }
    } catch(e) {
        console.error('Error parsing academic_qualifications_text from context:', e);
    }
    {% endif %}
    
    // Direct initialization from context variable for teaching modules
    {% if teaching_modules_text and not is_edit_mode %}
    try {
        const teachingModules = JSON.parse('{{ teaching_modules_text|escapejs }}');
        if (Array.isArray(teachingModules)) {
            teachingModules.forEach(module => {
                createTeachingModuleRow({
                    title: module.title || '',
                    level: module.level || '',
                    language: module.languageMedium || '',
                    students: module.no_of_students || '',
                    percentage: module.percentage_jointly_taught || '',
                    hours: module.hrs_weekly || ''
                });
            });
            updateTeachingModulesText();
        }
    } catch(e) {
        console.error('Error parsing teaching_modules_text from context:', e);
    }
    {% endif %}

    // Auto-populate conference attendance from appraisals
    {% if conference_attendance_data and not is_edit_mode %}
    try {
        const attendanceData = JSON.parse('{{ conference_attendance_data|escapejs }}');
        if (attendanceData && attendanceData.length > 0) {
            attendanceData.forEach(event => {
                const row = document.createElement('tr');
                
                // Event Name
                const eventNameCell = document.createElement('td');
                eventNameCell.className = 'px-6 py-4 whitespace-nowrap';
                const eventNameInput = document.createElement('input');
                eventNameInput.type = 'text';
                eventNameInput.className = commonInputClasses;
                eventNameInput.value = event.event_name;
                eventNameCell.appendChild(eventNameInput);
                row.appendChild(eventNameCell);
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap';
                const typeInput = document.createElement('input');
                typeInput.type = 'text';
                typeInput.className = commonInputClasses;
                typeInput.value = event.type;
                typeCell.appendChild(typeInput);
                row.appendChild(typeCell);
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-6 py-4 whitespace-nowrap';
                const dateInput = document.createElement('input');
                dateInput.type = 'date';
                dateInput.className = commonInputClasses;
                dateInput.value = event.date;
                dateCell.appendChild(dateInput);
                row.appendChild(dateCell);
                
                // Location
                const locationCell = document.createElement('td');
                locationCell.className = 'px-6 py-4 whitespace-nowrap';
                const locationInput = document.createElement('input');
                locationInput.type = 'text';
                locationInput.className = commonInputClasses;
                locationInput.value = event.location;
                locationCell.appendChild(locationInput);
                row.appendChild(locationCell);
                
                // Role
                const roleCell = document.createElement('td');
                roleCell.className = 'px-6 py-4 whitespace-nowrap';
                const roleInput = document.createElement('input');
                roleInput.type = 'text';
                roleInput.className = commonInputClasses;
                roleInput.value = event.role;
                roleCell.appendChild(roleInput);
                row.appendChild(roleCell);
                
                // Details
                const detailsCell = document.createElement('td');
                detailsCell.className = 'px-6 py-4 whitespace-nowrap';
                const detailsInput = document.createElement('input');
                detailsInput.type = 'text';
                detailsInput.className = commonInputClasses;
                detailsInput.value = event.details;
                detailsCell.appendChild(detailsInput);
                row.appendChild(detailsCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap';
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                `;
                deleteButton.addEventListener('click', function() {
                    row.remove();
                    updateAttendanceData();
                });
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                document.getElementById('conferenceAttendanceTable').appendChild(row);
            });
            
            updateAttendanceData();
        }
    } catch (e) {
        console.error('Error parsing conference attendance data:', e);
    }
    {% endif %}
    
    // Auto-populate administrative positions from appraisals
    {% if administrative_positions_data and not is_edit_mode %}
    try {
        const positionsData = JSON.parse('{{ administrative_positions_data|escapejs }}');
        if (positionsData && positionsData.length > 0) {
            positionsData.forEach(position => {
                const row = document.createElement('tr');
                
                // Position Title
                const titleCell = document.createElement('td');
                titleCell.className = 'px-6 py-4 whitespace-nowrap';
                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.className = commonInputClasses;
                titleInput.value = position.title;
                titleCell.appendChild(titleInput);
                row.appendChild(titleCell);
                
                // From Date
                const fromDateCell = document.createElement('td');
                fromDateCell.className = 'px-6 py-4 whitespace-nowrap';
                const fromDateInput = document.createElement('input');
                fromDateInput.type = 'date';
                fromDateInput.className = commonInputClasses;
                fromDateInput.value = position.from_date;
                fromDateCell.appendChild(fromDateInput);
                row.appendChild(fromDateCell);
                
                // To Date
                const toDateCell = document.createElement('td');
                toDateCell.className = 'px-6 py-4 whitespace-nowrap';
                const toDateInput = document.createElement('input');
                toDateInput.type = 'date';
                toDateInput.className = commonInputClasses;
                toDateInput.value = position.to_date;
                toDateCell.appendChild(toDateInput);
                row.appendChild(toDateCell);
                
                // Details
                const detailsCell = document.createElement('td');
                detailsCell.className = 'px-6 py-4 whitespace-nowrap';
                const detailsInput = document.createElement('input');
                detailsInput.type = 'text';
                detailsInput.className = commonInputClasses;
                detailsInput.value = position.details;
                detailsCell.appendChild(detailsInput);
                row.appendChild(detailsCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap';
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                `;
                deleteButton.addEventListener('click', function() {
                    row.remove();
                    updateAdministrativePositionsData();
                });
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                document.getElementById('administrativePositionsTable').querySelector('tbody').appendChild(row);
            });
            
            updateAdministrativePositionsData();
        }
    } catch (e) {
        console.error('Error parsing administrative positions data:', e);
    }
    {% endif %}
    
    // Auto-populate university committees from appraisals
    {% if university_committees_data and not is_edit_mode %}
    try {
        const committeesData = JSON.parse('{{ university_committees_data|escapejs }}');
        if (committeesData && committeesData.length > 0) {
            committeesData.forEach(committee => {
                const row = document.createElement('tr');
                
                // Committee Name
                const nameCell = document.createElement('td');
                nameCell.className = 'px-6 py-4 whitespace-nowrap';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = commonInputClasses;
                nameInput.value = committee.committee_name;
                nameCell.appendChild(nameInput);
                row.appendChild(nameCell);
                
                // Position
                const positionCell = document.createElement('td');
                positionCell.className = 'px-6 py-4 whitespace-nowrap';
                const positionInput = document.createElement('input');
                positionInput.type = 'text';
                positionInput.className = commonInputClasses;
                positionInput.value = committee.position;
                positionCell.appendChild(positionInput);
                row.appendChild(positionCell);
                
                // From Date
                const fromDateCell = document.createElement('td');
                fromDateCell.className = 'px-6 py-4 whitespace-nowrap';
                const fromDateInput = document.createElement('input');
                fromDateInput.type = 'date';
                fromDateInput.className = commonInputClasses;
                fromDateInput.value = committee.from_date;
                fromDateCell.appendChild(fromDateInput);
                row.appendChild(fromDateCell);
                
                // To Date
                const toDateCell = document.createElement('td');
                toDateCell.className = 'px-6 py-4 whitespace-nowrap';
                const toDateInput = document.createElement('input');
                toDateInput.type = 'date';
                toDateInput.className = commonInputClasses;
                toDateInput.value = committee.to_date;
                toDateCell.appendChild(toDateInput);
                row.appendChild(toDateCell);
                
                // Details
                const detailsCell = document.createElement('td');
                detailsCell.className = 'px-6 py-4 whitespace-nowrap';
                const detailsInput = document.createElement('input');
                detailsInput.type = 'text';
                detailsInput.className = commonInputClasses;
                detailsInput.value = committee.details;
                detailsCell.appendChild(detailsInput);
                row.appendChild(detailsCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap';
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                `;
                deleteButton.addEventListener('click', function() {
                    row.remove();
                    updateUniversityCommitteesData();
                });
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                document.getElementById('universityCommitteesTable').querySelector('tbody').appendChild(row);
            });
            
            updateUniversityCommitteesData();
        }
    } catch (e) {
        console.error('Error parsing university committees data:', e);
    }
    {% endif %}
    
    // Auto-populate external committees from appraisals
    {% if external_committees_data and not is_edit_mode %}
    try {
        const committeesData = JSON.parse('{{ external_committees_data|escapejs }}');
        if (committeesData && committeesData.length > 0) {
            committeesData.forEach(committee => {
                const row = document.createElement('tr');
                
                // Organization
                const orgCell = document.createElement('td');
                orgCell.className = 'px-6 py-4 whitespace-nowrap';
                const orgInput = document.createElement('input');
                orgInput.type = 'text';
                orgInput.className = commonInputClasses;
                orgInput.value = committee.organization;
                orgCell.appendChild(orgInput);
                row.appendChild(orgCell);
                
                // Position
                const positionCell = document.createElement('td');
                positionCell.className = 'px-6 py-4 whitespace-nowrap';
                const positionInput = document.createElement('input');
                positionInput.type = 'text';
                positionInput.className = commonInputClasses;
                positionInput.value = committee.position;
                positionCell.appendChild(positionInput);
                row.appendChild(positionCell);
                
                // From Date
                const fromDateCell = document.createElement('td');
                fromDateCell.className = 'px-6 py-4 whitespace-nowrap';
                const fromDateInput = document.createElement('input');
                fromDateInput.type = 'date';
                fromDateInput.className = commonInputClasses;
                fromDateInput.value = committee.from_date;
                fromDateCell.appendChild(fromDateInput);
                row.appendChild(fromDateCell);
                
                // To Date
                const toDateCell = document.createElement('td');
                toDateCell.className = 'px-6 py-4 whitespace-nowrap';
                const toDateInput = document.createElement('input');
                toDateInput.type = 'date';
                toDateInput.className = commonInputClasses;
                toDateInput.value = committee.to_date;
                toDateCell.appendChild(toDateInput);
                row.appendChild(toDateCell);
                
                // Details
                const detailsCell = document.createElement('td');
                detailsCell.className = 'px-6 py-4 whitespace-nowrap';
                const detailsInput = document.createElement('input');
                detailsInput.type = 'text';
                detailsInput.className = commonInputClasses;
                detailsInput.value = committee.details;
                detailsCell.appendChild(detailsInput);
                row.appendChild(detailsCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap';
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                `;
                deleteButton.addEventListener('click', function() {
                    row.remove();
                    updateExternalCommitteesData();
                });
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                document.getElementById('externalCommitteesTable').querySelector('tbody').appendChild(row);
            });
            
            updateExternalCommitteesData();
        }
    } catch (e) {
        console.error('Error parsing external committees data:', e);
    }
    {% endif %}

    // Auto-populate from appraisals if data is available
    {% if conference_attendance_data and not is_edit_mode %}
    try {
        const attendanceData = JSON.parse('{{ conference_attendance_data|escapejs }}');
        attendanceData.forEach(entry => {
            createAttendanceRow(entry);
        });
    } catch (e) {
        console.error("Error parsing conference_attendance_data:", e);
    }
    {% endif %}

    {% if administrative_positions_data and not is_edit_mode %}
    try {
        const adminPositionsData = JSON.parse('{{ administrative_positions_data|escapejs }}');
        adminPositionsData.forEach(position => {
            // Create a new row
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${position.title || ''}" placeholder="Enter Position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="date" 
                           value="${position.from_date || ''}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                           pattern="\d{4}-\d{2}-\d{2}"
                           placeholder="YYYY-MM-DD"
                           required>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="date" 
                           value="${position.to_date || ''}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                           pattern="\d{4}-\d{2}-\d{2}"
                           placeholder="YYYY-MM-DD">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${position.details || ''}" placeholder="Details" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateAdministrativePositionsData();">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete
                    </button>
                </td>
            `;

            administrativePositionsTable.querySelector('tbody').appendChild(row);
        });
        updateAdministrativePositionsData();
    } catch (e) {
        console.error("Error parsing administrative_positions_data:", e);
    }
    {% endif %}

    {% if university_committees_data and not is_edit_mode %}
    try {
        const committeesData = JSON.parse('{{ university_committees_data|escapejs }}');
        committeesData.forEach(committee => {
            createUniversityCommitteeRow({
                name: committee.committee_name || '',
                position: committee.position || '',
                from_date: committee.from_date || '',
                to_date: committee.to_date || '',
                details: committee.details || ''
            });
        });
        updateUniversityCommitteesData();
    } catch (e) {
        console.error("Error parsing university_committees_data:", e);
    }
    {% endif %}

    {% if external_committees_data and not is_edit_mode %}
    try {
        const committeesData = JSON.parse('{{ external_committees_data|escapejs }}');
        committeesData.forEach(committee => {
            createExternalCommitteeRow({
                organization: committee.organization || '',
                position: committee.position || '',
                from_date: committee.from_date || '',
                to_date: committee.to_date || '',
                details: committee.details || ''
            });
        });
        updateExternalCommitteesData();
    } catch (e) {
        console.error("Error parsing external_committees_data:", e);
    }
    {% endif %}

    {% if consultancy_work_data and not is_edit_mode %}
    try {
        const consultancyData = JSON.parse('{{ consultancy_work_data|escapejs }}');
        consultancyData.forEach(entry => {
            // Create a new row for consultancy work
            const newRow = document.createElement('tr');
            
            // Set the HTML content of the row
            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${entry.title || ''}" placeholder="Title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${entry.company_institute || ''}" placeholder="Company/Institute" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="date" value="${entry.start_date || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="date" value="${entry.end_date || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateConsultancyData();">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete
                    </button>
                </td>
            `;
            
            // Append the row to the consultancy work table
            if (consultancyTable && consultancyTable.querySelector('tbody')) {
                consultancyTable.querySelector('tbody').appendChild(newRow);
            } else {
                console.error("Cannot find consultancy table tbody:", consultancyTable);
            }
        });
        
        // Update the hidden input field with the consultancy work data
        updateConsultancyData();
    } catch (e) {
        console.error("Error parsing consultancy_work_data:", e);
    }
    {% endif %}

    {% if conference_papers_data and not is_edit_mode %}
    try {
        const papersData = JSON.parse('{{ conference_papers_data|escapejs }}');
        papersData.forEach(paper => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${paper.author || ''}" placeholder="Author(s)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${paper.year || ''}" placeholder="Year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${paper.title || ''}" placeholder="Title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${paper.volume || ''}" placeholder="Volume" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${paper.pages || ''}" placeholder="Pages" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" value="${paper.doi || ''}" placeholder="DOI" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <button type="button" class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2" onclick="this.closest('tr').remove(); updateConferencePapersData();">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete
                    </button>
                </td>
            `;
            
            conferencePapersTable.querySelector('tbody').appendChild(row);
        });
        updateConferencePapersData();
    } catch (e) {
    }
    {% endif %}

    {% if participation_within_data and not is_edit_mode %}
    try {
        const activitiesData = JSON.parse('{{ participation_within_data|escapejs }}');
        activitiesData.forEach(activity => {
            createParticipationRow('participationWithinTable', {
                activity: activity.activity || '',
                role: activity.role || '',
                date: activity.date || '',
                remarks: activity.remarks || ''
            });
        });
    } catch (e) {
    }
    {% endif %}

    {% if participation_outside_data and not is_edit_mode %}
    try {
        const activitiesData = JSON.parse('{{ participation_outside_data|escapejs }}');
        activitiesData.forEach(activity => {
            createParticipationRow('participationOutsideTable', {
                activity: activity.activity || '',
                role: activity.role || '',
                date: activity.date || '',
                remarks: activity.remarks || ''
            });
        });
    } catch (e) {
    }
    {% endif %}
    // Add form validation before submission

    // Function to update consultancy work data
    function updateConsultancyWorkData() {
        const consultancyData = [];
        const rows = consultancyTable.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            consultancyData.push({
                title: inputs[0].value || '',
                company_institute: inputs[1].value || '',
                start_date: inputs[2].value || '',
                end_date: inputs[3].value || ''
            });
        });
        
        document.getElementById('consultancy_work').value = JSON.stringify(consultancyData);
        return consultancyData.length;
    }
    
    // Add event listener for consultancy table changes
    consultancyTable.addEventListener('change', updateConsultancyWorkData);
    
    // Auto-populate from appraisals if data is available
});

// Function to update consultancy work data
function updateConsultancyWorkData() {
    const consultancyData = [];
    const rows = consultancyTable.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        consultancyData.push({
            title: inputs[0].value || '',
            company_institute: inputs[1].value || '',
            start_date: inputs[2].value || '',
            end_date: inputs[3].value || ''
        });
    });
    
    document.getElementById('consultancy_work').value = JSON.stringify(consultancyData);
    return consultancyData.length;
}

// Add event listener for consultancy table changes
consultancyTable.addEventListener('change', updateConsultancyWorkData);

// Auto-populate from appraisals if data is available
</script>

<style>
    /* Additional CSS for section styling */
    .section-header {
        position: relative;
        margin-bottom: 2rem;
    }

    .section-header::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: -0.5rem;
        width: 100%;
        height: 2px;
        background: linear-gradient(to right, #e5e7eb, transparent);
    }

    /* Hover effect for sections */
    .bg-white.p-6.rounded-lg.shadow-md:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transform: translateY(-2px);
        transition: all 0.2s ease;
    }

    /* Style for readonly inputs */
    input[readonly], select[disabled] {
        background-color: #f9fafb;
        border-color: #e5e7eb;
        cursor: not-allowed;
    }

    /* Add subtle border to separate sections */
    .space-y-8 > div {
        position: relative;
    }

    .space-y-8 > div::before {
        content: '';
        position: absolute;
        top: -1rem;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(to right, transparent, #e5e7eb, transparent);
    }
</style>

{% if is_edit_mode %}
<div class="bg-gray-100 p-4 my-4 rounded" style="display: none;">
    <h3 class="text-lg font-bold">Debug Data</h3>
    <pre class="text-xs overflow-auto max-h-40">{{ debug_data|json_script:"debug-data" }}</pre>
    
    <h4 class="font-bold mt-2">Contract Data JSON:</h4>
    <pre class="text-xs overflow-auto max-h-40">{{ contract_data_json|json_script:"contract-data-json" }}</pre>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const debugData = JSON.parse(document.getElementById('debug-data').textContent);
            const contractDataJson = JSON.parse(document.getElementById('contract-data-json').textContent);
            
            console.log('Debug Data:', debugData);
            console.log('Contract Data JSON:', contractDataJson);
        });
    </script>
</div>
{% endif %}
{% endblock %}