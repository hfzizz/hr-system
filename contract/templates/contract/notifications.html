{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Notifications</h1>
    
    <div class="space-y-4">
        {% for notification in notifications %}
            <div class="bg-white shadow rounded-lg p-4 {% if not notification.read %}border-l-4 border-blue-500{% endif %} relative"
                 data-notification-id="{{ notification.id }}">
                <!-- Delete Button -->
                <button onclick="deleteNotification({{ notification.id }})" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-500">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <!-- Notification Content -->
                <div class="text-gray-700 pr-8" style="word-break: break-word;">{{ notification.message|safe }}</div>
                
                <!-- Contract Review Link -->
                {% if notification.contract %}
                    <div class="mt-3">
                        <a href="{% url 'contract:review' notification.contract.id %}" 
                           onclick="markAsRead({{ notification.id }})"
                           class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                            <span>Review Contract</span>
                            <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                {% endif %}
                
                <!-- Timestamp -->
                <p class="text-sm text-gray-500 mt-2">{{ notification.created_at|date:"M d, Y H:i" }}</p>
            </div>
        {% empty %}
            <div class="text-center text-gray-500">
                No notifications found
            </div>
        {% endfor %}
    </div>
</div>

<script>
async function deleteNotification(notificationId) {
    if (!confirm('Are you sure you want to delete this notification?')) {
        return;
    }
    
    try {
        const response = await fetch(`{% url 'contract:delete_notification' 0 %}`.replace('0', notificationId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        });

        if (response.ok) {
            // Remove the notification element from the DOM
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.remove();
            } else {
                // If we can't find the element, reload the page
                window.location.reload();
            }
        } else {
            alert('Error deleting notification');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting notification');
    }
}

async function markAsRead(notificationId) {
    try {
        await fetch(`/contract/notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        });
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}
</script>
{% endblock %} 