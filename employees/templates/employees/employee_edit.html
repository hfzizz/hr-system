{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Edit Employee - HR System{% endblock %}

{% block extra_js %}
<script src="{% static 'employees/js/employee_create.js' %}"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">Edit Employee</h1>
        <a href="{% url 'employees:employee_list' %}" 
           class="rounded-md bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm hover:bg-gray-200">
            Back to List
        </a>
    </div>

    <!-- Form -->
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-lg">
        <form method="post" enctype="multipart/form-data" class="space-y-8 p-6">
            {% csrf_token %}
            
            <!-- Employee ID Section -->
            <div class="space-y-6">
                <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-2">
                    <div>
                        <label for="id_employee_id" class="block text-sm font-medium text-gray-700">Employee ID</label>
                        {% render_field form.employee_id class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 bg-gray-50 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" readonly="readonly" %}
                        <p class="mt-1 text-sm text-gray-500">Employee ID cannot be changed</p>
                    </div>
                </div>
            </div>

            <!-- Employee Information -->
            <div class="space-y-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Employee Information</h3>
                <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-2">
                    <!-- First Name -->
                    <div>
                        <label for="id_first_name" class="block text-sm font-medium text-gray-700">First Name</label>
                        {% render_field form.first_name class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.first_name.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.first_name.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Last Name -->
                    <div>
                        <label for="id_last_name" class="block text-sm font-medium text-gray-700">Last Name</label>
                        {% render_field form.last_name class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.last_name.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.last_name.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Email -->
                    <div>
                        <label for="id_email" class="block text-sm font-medium text-gray-700">Email</label>
                        {% render_field form.email class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.email.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.email.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- IC Number and IC Colour on the same line -->
                    <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-x-6">
                        <div>
                            <label for="id_ic_no" class="block text-sm font-medium text-gray-700">IC Number</label>
                            {% render_field form.ic_no class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                            {% if form.ic_no.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.ic_no.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="id_ic_colour" class="block text-sm font-medium text-gray-700">IC Colour</label>
                            {% render_field form.ic_colour class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                            {% if form.ic_colour.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.ic_colour.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Phone Number -->
                    <div>
                        <label for="id_phone_number" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        {% render_field form.phone_number class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.phone_number.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.phone_number.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Date of Birth -->
                    <div>
                        <label for="id_date_of_birth" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                        {% render_field form.date_of_birth class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.date_of_birth.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.date_of_birth.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Type of Appointment -->
                    <div>
                        <label for="id_appointment_type" class="block text-sm font-medium text-gray-700">Type of Appointment</label>
                        {% render_field form.appointment_type class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.appointment_type.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.appointment_type.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Hire Date -->
                    <div>
                        <label for="id_hire_date" class="block text-sm font-medium text-gray-700">Hire Date</label>
                        {% render_field form.hire_date class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.hire_date.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.hire_date.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Position -->
                    <div>
                        <label for="id_post" class="block text-sm font-medium text-gray-700">Position</label>
                        {% render_field form.post class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.post.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.post.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Department -->
                    <div>
                        <label for="id_department" class="block text-sm font-medium text-gray-700">Department</label>
                        {% render_field form.department class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.department.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.department.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Salary -->
                    <div>
                        <label for="id_salary" class="block text-sm font-medium text-gray-700">Salary</label>
                        {% render_field form.salary class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.salary.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.salary.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Employee Status -->
                    <div>
                        <label for="id_employee_status" class="block text-sm font-medium text-gray-700">Status</label>
                        {% render_field form.employee_status class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" %}
                        {% if form.employee_status.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.employee_status.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Roles - Checkbox Group with 2 Columns -->
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Roles
                        </label>
                        <div class="max-h-48 overflow-y-auto p-3 bg-white rounded-md border border-gray-300">
                            <div class="grid grid-cols-2 gap-4">
                                {% for choice in form.roles.field.queryset %}
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                        name="roles" 
                                        value="{{ choice.id }}" 
                                        id="role_{{ choice.id }}"
                                        {% if choice in form.instance.roles.all %}checked{% endif %}
                                        class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
                                    <label for="role_{{ choice.id }}" class="ml-2 text-sm text-gray-900 truncate">
                                        {{ choice.name }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if form.roles.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.roles.errors.0 }}</p>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">Select all applicable roles</p>
                    </div>

                    <!-- Address -->
                    <div class="sm:col-span-2">
                        <label for="id_address" class="block text-sm font-medium text-gray-700">Address</label>
                        {% render_field form.address class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" rows="3" %}
                        {% if form.address.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.address.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Academic Qualifications -->
                    <div class="space-y-6 sm:col-span-2">
                        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl p-6 w-full">
                            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">Academic Qualifications</h3>
                            <div class="w-full">
                                {{ qualification_formset.management_form }}
                                
                                <!-- Add the template before the table -->
                                <template id="empty-form-template">
                                    <tr class="qualification-form">
                                        <input type="hidden" 
                                               name="qualification_set-__prefix__-employee" 
                                               id="id_qualification_set-__prefix__-employee"
                                               value="{{ object.id }}">
                                        
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900 sm:pl-6">
                                            <input type="text" 
                                                   name="qualification_set-__prefix__-degree_diploma" 
                                                   id="id_qualification_set-__prefix__-degree_diploma"
                                                   class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                            <input type="text" 
                                                   name="qualification_set-__prefix__-university_college" 
                                                   id="id_qualification_set-__prefix__-university_college"
                                                   class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                            <input type="date" 
                                                   name="qualification_set-__prefix__-from_date" 
                                                   id="id_qualification_set-__prefix__-from_date"
                                                   class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                            <input type="date" 
                                                   name="qualification_set-__prefix__-to_date" 
                                                   id="id_qualification_set-__prefix__-to_date"
                                                   class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                            <input type="hidden" 
                                                   name="qualification_set-__prefix__-DELETE" 
                                                   id="id_qualification_set-__prefix__-DELETE">
                                            <button type="button" 
                                                    onclick="window.deleteQualification(this)"
                                                    class="inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                </template>

                                <div class="overflow-x-auto ring-1 ring-gray-300 rounded-lg w-full">
                                    <table class="min-w-full divide-y divide-gray-300">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Degree/Diploma</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">University/College</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">From Date</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">To Date</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200 bg-white" id="qualification-formset">
                                            {% for form in qualification_formset %}
                                                <tr class="qualification-form {% if form.DELETE.value %}d-none{% endif %}">
                                                    {{ form.id }}
                                                    <input type="hidden" 
                                                           name="qualification_set-{{ forloop.counter0 }}-employee" 
                                                           id="id_qualification_set-{{ forloop.counter0 }}-employee"
                                                           value="{{ object.id }}">
                                                    
                                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900 sm:pl-6">
                                                        <input type="text" 
                                                               name="qualification_set-{{ forloop.counter0 }}-degree_diploma" 
                                                               id="id_qualification_set-{{ forloop.counter0 }}-degree_diploma"
                                                               value="{{ form.instance.degree_diploma|default:'' }}"
                                                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                    </td>
                                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                                        <input type="text" 
                                                               name="qualification_set-{{ forloop.counter0 }}-university_college" 
                                                               id="id_qualification_set-{{ forloop.counter0 }}-university_college"
                                                               value="{{ form.instance.university_college|default:'' }}"
                                                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                    </td>
                                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                                        <input type="date" 
                                                               name="qualification_set-{{ forloop.counter0 }}-from_date" 
                                                               id="id_qualification_set-{{ forloop.counter0 }}-from_date"
                                                               value="{{ form.instance.from_date|date:'Y-m-d'|default:'' }}"
                                                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                    </td>
                                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                                        <input type="date" 
                                                               name="qualification_set-{{ forloop.counter0 }}-to_date" 
                                                               id="id_qualification_set-{{ forloop.counter0 }}-to_date"
                                                               value="{{ form.instance.to_date|date:'Y-m-d'|default:'' }}"
                                                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                    </td>
                                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                                        <input type="hidden" 
                                                               name="qualification_set-{{ forloop.counter0 }}-DELETE" 
                                                               id="id_qualification_set-{{ forloop.counter0 }}-DELETE">
                                                        <button type="button" 
                                                                onclick="window.deleteQualification(this)"
                                                                class="inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
                                                            Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-6">
                                    <button type="button" 
                                            onclick="window.addQualification()"
                                            class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                                        Add Another Qualification
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Upload Section -->
                    <div class="space-y-6 sm:col-span-2">
                        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl p-6 w-full">
                            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">Documents</h3>
                            <div class="w-full">
                                {{ document_formset.management_form }}
                                
                                <!-- Document template -->
                                <template id="empty-document-template">
                                    <tr class="document-form">
                                        <input type="hidden" 
                                               name="document_set-__prefix__-employee" 
                                               id="id_document_set-__prefix__-employee"
                                               value="{{ object.id }}">
                                        
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900 sm:pl-6">
                                            <input type="text" 
                                                   name="document_set-__prefix__-title" 
                                                   id="id_document_set-__prefix__-title"
                                                   class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                                                   placeholder="Document Title">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                            {% if form.instance.file %}
                                                <div class="flex items-center space-x-2">
                                                    <a href="{{ form.instance.file.url }}" 
                                                       class="text-indigo-600 hover:text-indigo-900"
                                                       target="_blank">
                                                        {{ form.instance.file.name|slice:"11:" }}
                                                    </a>
                                                    <button type="button"
                                                            onclick="this.nextElementSibling.classList.remove('hidden'); this.remove()"
                                                            class="text-sm text-gray-500 hover:text-gray-700">
                                                        (Change)
                                                    </button>
                                                    <div class="hidden w-full">
                                                        <input type="file" 
                                                               name="document_set-__prefix__-file" 
                                                               id="id_document_set-__prefix__-file"
                                                               class="block w-full text-sm text-gray-500
                                                                      file:mr-4 file:py-2 file:px-4
                                                                      file:rounded-md file:border-0
                                                                      file:text-sm file:font-semibold
                                                                      file:bg-indigo-50 file:text-indigo-700
                                                                      hover:file:bg-indigo-100">
                                                    </div>
                                                </div>
                                            {% else %}
                                                <input type="file" 
                                                       name="document_set-__prefix__-file" 
                                                       id="id_document_set-__prefix__-file"
                                                       class="block w-full text-sm text-gray-500
                                                              file:mr-4 file:py-2 file:px-4
                                                              file:rounded-md file:border-0
                                                              file:text-sm file:font-semibold
                                                              file:bg-indigo-50 file:text-indigo-700
                                                              hover:file:bg-indigo-100">
                                            {% endif %}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                            <input type="hidden" 
                                                   name="document_set-__prefix__-DELETE" 
                                                   id="id_document_set-__prefix__-DELETE">
                                            <button type="button" 
                                                    onclick="window.deleteDocument(this)"
                                                    class="inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                </template>

                                <div class="overflow-x-auto ring-1 ring-gray-300 rounded-lg w-full">
                                    <table class="min-w-full divide-y divide-gray-300">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Title</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">File</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200 bg-white" id="document-formset">
                                            {% for form in document_formset %}
                                                <tr class="document-form {% if form.DELETE.value %}d-none{% endif %}">
                                                    {{ form.id }}
                                                    <input type="hidden" 
                                                           name="document_set-{{ forloop.counter0 }}-employee" 
                                                           id="id_document_set-{{ forloop.counter0 }}-employee"
                                                           value="{{ object.id }}">
                                                    
                                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900 sm:pl-6">
                                                        <input type="text" 
                                                               name="document_set-{{ forloop.counter0 }}-title" 
                                                               id="id_document_set-{{ forloop.counter0 }}-title"
                                                               value="{{ form.instance.title|default:'' }}"
                                                               class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                    </td>
                                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                                        {% if form.instance.file %}
                                                            <div class="flex items-center space-x-2">
                                                                <a href="{{ form.instance.file.url }}" 
                                                                   class="text-indigo-600 hover:text-indigo-900"
                                                                   target="_blank">
                                                                    {{ form.instance.file.name|slice:"11:" }}
                                                                </a>
                                                                <button type="button"
                                                                        onclick="this.nextElementSibling.classList.remove('hidden'); this.remove()"
                                                                        class="text-sm text-gray-500 hover:text-gray-700">
                                                                    (Change)
                                                                </button>
                                                                <div class="hidden w-full">
                                                                    <input type="file" 
                                                                           name="document_set-{{ forloop.counter0 }}-file" 
                                                                           id="id_document_set-{{ forloop.counter0 }}-file"
                                                                           class="block w-full text-sm text-gray-500
                                                                                  file:mr-4 file:py-2 file:px-4
                                                                                  file:rounded-md file:border-0
                                                                                  file:text-sm file:font-semibold
                                                                                  file:bg-indigo-50 file:text-indigo-700
                                                                                  hover:file:bg-indigo-100">
                                                                </div>
                                                            </div>
                                                        {% else %}
                                                            <input type="file" 
                                                                   name="document_set-{{ forloop.counter0 }}-file" 
                                                                   id="id_document_set-{{ forloop.counter0 }}-file"
                                                                   class="block w-full text-sm text-gray-500
                                                                          file:mr-4 file:py-2 file:px-4
                                                                          file:rounded-md file:border-0
                                                                          file:text-sm file:font-semibold
                                                                          file:bg-indigo-50 file:text-indigo-700
                                                                          hover:file:bg-indigo-100">
                                                        {% endif %}
                                                    </td>
                                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                                        <input type="hidden" 
                                                               name="document_set-{{ forloop.counter0 }}-DELETE" 
                                                               id="id_document_set-{{ forloop.counter0 }}-DELETE">
                                                        <button type="button" 
                                                                onclick="window.deleteDocument(this)"
                                                                class="inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
                                                            Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-6">
                                    <button type="button" 
                                            onclick="window.addDocument()"
                                            class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                                        Add Document
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Errors -->
                    {% if form.errors %}
                    <div class="rounded-md bg-red-50 p-4 mb-6">
                        <div class="flex">
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Please correct the following errors:</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc pl-5 space-y-1">
                                        {% for field, errors in form.errors.items %}
                                            {% if field == '__all__' %}
                                                {% for error in errors %}
                                                    <li>{{ error }}</li>
                                                {% endfor %}
                                            {% else %}
                                                {% for error in errors %}
                                                    <li>{{ field }}: {{ error }}</li>
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Form Actions - Moved to end of form, before closing form tag -->
            <div class="mt-8 border-t border-gray-900/10 pt-6">
                <div class="flex items-center justify-end gap-x-6">
                    <a href="{% url 'employees:employee_detail' employee.pk %}" 
                       class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600">
                        Cancel
                    </a>
                    <button type="submit"
                            class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        Save Changes
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    console.log('Template loaded');
</script>
<script src="{% static 'employees/js/employee_create.js' %}"></script>
{% if not form.errors and not form.non_field_errors %}
    <script>
        localStorage.removeItem('draft_qualifications');
    </script>
{% endif %}
{% endblock %} 