{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            {% if has_prev %}
                <a href="{% url 'employees:bulk_employee_edit' index|add:'-1' %}" class="rounded bg-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-300">&larr; Previous Employee</a>
            {% endif %}
        </div>
        <a href="{% url 'employees:bulk_add' %}" class="rounded bg-blue-100 px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-200">Return to List</a>
        <div>
            {% if has_next %}
                <a href="{% url 'employees:bulk_employee_edit' index|add:'1' %}" class="rounded bg-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-300">Next Employee &rarr;</a>
            {% endif %}
        </div>
    </div>
    <form method="post" class="bg-white shadow-md rounded-lg p-8">
        {% csrf_token %}
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">Employee Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">First Name</label>
                <input type="text" name="first_name" value="{{ employee.first_name }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" required data-field="first_name">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Last Name</label>
                <input type="text" name="last_name" value="{{ employee.last_name }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" required data-field="last_name">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" name="email" value="{{ employee.email }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" required data-field="email">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                <input type="text" name="phone_number" value="{{ employee.phone_number }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="phone_number">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">IC Number</label>
                <input type="text" name="ic_no" value="{{ employee.ic_no }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="ic_no">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">IC Colour</label>
                <select name="ic_colour" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="ic_colour">
                    <option value="">---------</option>
                    {% for val, label in ic_colour_choices %}
                        <option value="{{ val }}" {% if employee.ic_colour == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                <input type="date" name="date_of_birth" value="{{ employee.date_of_birth }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="date_of_birth">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Gender</label>
                <select name="gender" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="gender">
                    <option value="">---------</option>
                    {% for val, label in gender_choices %}
                        <option value="{{ val }}" {% if employee.gender == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">Address</label>
                <textarea name="address" rows="2" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="address">{{ employee.address }}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Hire Date</label>
                <input type="date" name="hire_date" value="{{ employee.hire_date }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="hire_date">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Salary</label>
                <input type="number" step="0.01" name="salary" value="{{ employee.salary }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="salary">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Type of Appointment</label>
                <select name="appointment_type" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="appointment_type">
                    <option value="">---------</option>
                    {% for val, label in appointment_type_choices %}
                        <option value="{{ val }}" {% if employee.appointment_type == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Employee Status</label>
                <select name="employee_status" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="employee_status">
                    <option value="">---------</option>
                    {% for val, label in status_choices %}
                        <option value="{{ val }}" {% if employee.employee_status == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Post</label>
                <input type="text" name="post" value="{{ employee.post }}" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="post">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Department</label>
                <select name="department" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 autosave-field" data-field="department">
                    <option value="">---------</option>
                    {% for dept in department_list %}
                        <option value="{{ dept.id }}" {% if employee.department == dept.id or employee.department == dept %}selected{% endif %}>{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div id="autosave-status" class="text-sm text-gray-500 mt-4" style="display:none;">Saving...</div>
        <script>
        const fields = document.querySelectorAll('.autosave-field');
        const status = document.getElementById('autosave-status');
        let saveTimeout = null;
        fields.forEach(field => {
            field.addEventListener('change', autosave);
            field.addEventListener('blur', autosave);
        });
        function autosave(e) {
            const field = e.target;
            const fieldName = field.getAttribute('data-field');
            let value = field.value;
            status.textContent = 'Saving...';
            status.style.display = 'block';
            fetch(`{% url 'employees:bulk_employee_autosave' index %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: `field=${encodeURIComponent(fieldName)}&value=${encodeURIComponent(value)}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'Saved';
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => { status.style.display = 'none'; }, 1000);
                } else {
                    status.textContent = 'Error saving';
                }
            })
            .catch(() => {
                status.textContent = 'Error saving';
            });
        }
        </script>
    </form>
    <form method="post" action="{% url 'employees:bulk_employee_delete' index %}" class="mt-8">
        {% csrf_token %}
        <input type="hidden" name="from_edit" value="1">
        <button type="submit" class="rounded bg-red-600 hover:bg-red-800 text-white px-4 py-2 text-sm font-semibold shadow">Delete Employee</button>
    </form>
</div>
{% endblock %} 