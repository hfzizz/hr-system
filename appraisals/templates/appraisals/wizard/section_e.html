{% extends "base.html" %}
{% load static %}

{% block title %}Appraisal Wizard - Section E{% endblock %}

{% block content %}

<div id="wizard-container">
<!-- Script block for section E functionality -->
<script>
    document.addEventListener('htmx:configRequest', function(event) {
        const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content') || 
                     document.querySelector('[name=csrfmiddlewaretoken]').value;
        event.detail.headers['X-CSRFToken'] = token;
    });

    document.addEventListener('DOMContentLoaded', function(){
        // Load saved data for the form
        loadSavedData();
    });

    // Add a global error handler to see AJAX errors
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
    });

    function loadSavedData() {
        console.log("Loading saved data...");
        fetch('{% url "appraisals:get_section_data" %}?section=E&appraisal_id={{ appraisal.appraisal_id }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);
                if (data && data.data) {
                    const formData = data.data;
                    
                    // Populate textarea fields
                    for (const [key, value] of Object.entries(formData)) {
                        // Handle text inputs, textareas and date fields
                        const field = document.querySelector(`input[type="text"][name="${key}"], input[type="date"][name="${key}"], textarea[name="${key}"]`);
                        if (field && value) {
                            field.value = value;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading saved data:', error);
            });
    }

    function saveDraft() {
        // Create a FormData object
        const form = document.getElementById('section-e-form');
        if (!form) {
            console.error("Form not found!");
            showSaveMessage('Error: Form not found', 'error');
            return;
        }
        
        const formData = new FormData(form);
        formData.append('is_draft', 'true');
        
        // Log what we're about to send
        console.log("Saving form data...");
        
        // Show the saving indicator
        const saveIndicator = document.getElementById('save-indicator');
        saveIndicator.classList.remove('htmx-indicator');
        saveIndicator.style.display = 'flex';
        
        // Use fetch API for more control
        fetch('{% url "appraisals:save_section_data" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log("Response status:", response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Server error: ${response.status} - ${text || 'No error message'}`);
                });
            }
            return response.text();
        })
        .then(data => {
            console.log('Draft saved successfully:', data);
            showSaveMessage('Draft saved successfully!');
            
            // Optionally reload the saved data to confirm it was saved
            setTimeout(() => loadSavedData(), 1000);
        })
        .catch(error => {
            console.error('Error saving draft:', error);
            showSaveMessage('Error saving draft: ' + error.message, 'error');
        })
        .finally(() => {
            // Hide the saving indicator
            saveIndicator.style.display = 'none';
            saveIndicator.classList.add('htmx-indicator');
        });
    }
    
    function submitAppraisal() {
        // Create a FormData object
        const form = document.getElementById('section-e-form');
        if (!form) {
            console.error("Form not found!");
            showSaveMessage('Error: Form not found', 'error');
            return;
        }
        
        const formData = new FormData(form);
        formData.append('is_final_submit', 'true');
        
        // Show the saving indicator
        const saveIndicator = document.getElementById('save-indicator');
        saveIndicator.classList.remove('htmx-indicator');
        saveIndicator.style.display = 'flex';
        
        // Use fetch API for the final submission
        fetch('{% url "appraisals:save_section_data" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log("Response status:", response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Server error: ${response.status} - ${text || 'No error message'}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Appraisal submitted successfully:', data);
            
            // Now update the appraisal status based on the current appraiser role
            return fetch('{% url "appraisals:update_appraisal_status" %}', {
                method: 'POST',
                body: JSON.stringify({
                    'appraisal_id': '{{ appraisal.appraisal_id }}',
                    'is_final_submit': true
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Server error: ${response.status} - ${text || 'No error message'}`);
                });
            }
            return response.json();
        })
        .then(statusData => {
            console.log('Status updated:', statusData);
            
            // Show appropriate message based on status
            let message = 'Appraisal submitted successfully!';
            if (statusData.status === 'secondary_review') {
                message = 'Appraisal submitted and sent to secondary appraiser for review.';
            } else if (statusData.status === 'completed') {
                message = 'Appraisal has been reviewed and finalized successfully!';
            }
            
            showSaveMessage(message);
            
            // Redirect to the appraisal detail page or dashboard
            setTimeout(() => {
                window.location.href = statusData.redirect_url || '/appraisals/forms/';
            }, 1500);
        })
        .catch(error => {
            console.error('Error submitting appraisal:', error);
            showSaveMessage('Error submitting appraisal: ' + error.message, 'error');
        })
        .finally(() => {
            // Hide the saving indicator
            saveIndicator.style.display = 'none';
            saveIndicator.classList.add('htmx-indicator');
        });
    }

    function showSaveMessage(message, type = 'success') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
        toast.className = `fixed bottom-4 left-4 ${bgColor} px-4 py-3 rounded z-50 border`;
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>

<meta name="csrf-token" content="{{ csrf_token }}">

<script src="{% static 'appraisals/js/appraisal-batch-save.js' %}"></script>

<form id="section-e-form" method="post" action="">
    {% csrf_token %}
    {{ wizard.management_form}}
    <input type="hidden" name="appraisal_id" value="{{ appraisal.appraisal_id }}">
    <input type="hidden" name="section" value="E">

<!-- Appraisal Wizard Section E -->
<div class="max-w-5xl mx-auto bg-white shadow-md rounded-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Section E: Review of Appraisal</h2>
    <p class="text-sm text-gray-600 mb-6 pb-2 border-b border-gray-200">
        To be completed by reviewing appraiser
    </p>

    <!-- E1. Comments -->
    <div class="mb-8 bg-gray-50 rounded-lg shadow-sm p-5 border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">E1. Comments</h3>
        
        <div class="mb-6">
            <textarea 
                class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                id="e_comments" 
                name="e_comments" 
                rows="6"
                placeholder="Enter your comments here"></textarea>
        </div>
    </div>

    <!-- E2. Recommendations -->
    <div class="mb-8 bg-gray-50 rounded-lg shadow-sm p-5 border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">E2. Recommendations for action, if any</h3>
        
        <div class="mb-6">
            <textarea 
                class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" 
                id="e_recommendations" 
                name="e_recommendations" 
                rows="4"
                placeholder="Enter your recommendations here"></textarea>
        </div>
    </div>

    <!-- E3. Relationship to the appraisee -->
    <div class="mb-8 bg-gray-50 rounded-lg shadow-sm p-5 border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">E3. Relationship to the appraisee</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div class="form-group">
                <label for="e_known_appraisee" class="block text-sm font-medium text-gray-700 mb-1">
                    a. I have known the appraisee for (Years and Months)
                </label>
                <input type="text" 
                       class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                       id="e_known_appraisee" 
                       name="e_known_appraisee"
                       placeholder="e.g. 2 years 6 months">
            </div>

            <div class="form-group">
                <label for="e_relationship" class="block text-sm font-medium text-gray-700 mb-1">
                    b. Relationship to appraisee (if related, state relationship)
                </label>
                <input type="text" 
                       class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                       id="e_relationship" 
                       name="e_relationship"
                       placeholder="e.g. Department Head">
            </div>
        </div>
    </div>

    <!-- Additional Details -->
    <div class="mb-8 bg-gray-50 rounded-lg shadow-sm p-5 border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">Additional Information</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
            <div class="form-group">
                <label for="e_date" class="block text-sm font-medium text-gray-700 mb-1">
                    Date
                </label>
                <input type="date" 
                       class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                       id="e_date" 
                       name="e_date">
            </div>

            <div class="form-group">
                <label for="e_substantive_post" class="block text-sm font-medium text-gray-700 mb-1">
                    Substantive Post
                </label>
                <input type="text" 
                       class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                       id="e_substantive_post" 
                       name="e_substantive_post"
                       placeholder="Enter substantive post">
            </div>

            <div class="form-group">
                <label for="e_administrative_post" class="block text-sm font-medium text-gray-700 mb-1">
                    Administrative Post
                </label>
                <input type="text" 
                       class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                       id="e_administrative_post" 
                       name="e_administrative_post"
                       placeholder="Enter administrative post">
            </div>
        </div>
    </div>

    <!-- For Official Use -->
    <div class="mb-8 bg-gray-50 rounded-lg shadow-sm p-5 border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">FOR OFFICIAL USE</h3>
        
        <div class="mb-6">
            <textarea 
                class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500" 
                id="e_official_use" 
                name="e_official_use" 
                rows="3"
                placeholder=""></textarea>
        </div>
    </div>

    <!-- Save indicator -->
    <div id="save-indicator" class="htmx-indicator fixed bottom-4 right-4 p-3 bg-white rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <svg class="animate-spin h-5 w-5 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700">Saving...</span>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
        <!-- Previous button -->
        <button type="submit" 
                name="wizard_goto_step" 
                value="{{ wizard.steps.prev }}" 
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors">
            <span class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Previous
            </span>
        </button>

        <!-- Save as Draft Button -->
        <button type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-green-500 transition-colors"
                id="save-draft-button"
                onclick="saveDraft()">
            <span class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                </svg>
                Save as Draft
            </span>
        </button>
        
        <div id="nav-indicator" class="htmx-indicator">
            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        
        <!-- Submit Final Button -->
        <button type="button"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"
                id="submit-button"
                onclick="submitAppraisal()">
            <span class="flex items-center">
                Submit Appraisal
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </span>
        </button>
    </div>
</div>
</form>
</div>
{% endblock %}