{% extends "base.html" %}
{% load static %}

{% block title %}Appraisal Wizard - Section D{% endblock %}

{% block content %}

<div id="wizard-container">
<!-- Script block for section D functionality -->
<script>
    document.addEventListener('htmx:configRequest', function(event) {
        const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content') || 
                     document.querySelector('[name=csrfmiddlewaretoken]').value;
        event.detail.headers['X-CSRFToken'] = token;
    });

    document.addEventListener('DOMContentLoaded', function(){
        // Get reference to the form and the Next button
        const form = document.getElementById('section-d-form');
        const nextButton = form.querySelector('button[type="submit"]:not([name="wizard_goto_step"])');
        
        if (nextButton) {
            nextButton.addEventListener('click', function(event) {
                // Prevent default form submission
                event.preventDefault();
                
                // Show saving indicator
                const saveIndicator = document.getElementById('save-indicator');
                saveIndicator.classList.remove('htmx-indicator');
                saveIndicator.style.display = 'flex';
                
                // Create form data
                const formData = new FormData(form);
                formData.append('is_draft', 'true');
                formData.append('auto_save', 'true');
                
                // Use fetch API to save the draft
                fetch('{% url "appraisals:save_section_data" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    console.log("Auto-save response status:", response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Server error: ${response.status} - ${text || 'No error message'}`);
                        });
                    }
                    return response.text();
                })
                .then(() => {
                    console.log('Form auto-saved before navigation');
                    // After successful save, submit the form to proceed to next step
                    form.submit();
                })
                .catch(error => {
                    console.error('Error auto-saving form:', error);
                    showSaveMessage('Auto-save failed, but continuing navigation', 'error');
                    // Continue with form submission even if auto-save fails
                    form.submit();
                })
                .finally(() => {
                    // Hide the saving indicator (though form will likely have navigated away by now)
                    saveIndicator.style.display = 'none';
                    saveIndicator.classList.add('htmx-indicator');
                });
            });
        }
        // Load saved data for the form
        loadSavedData();
    });

    // Add a global error handler to see AJAX errors
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
    });

    function loadSavedData() {
        console.log("Loading saved data...");
        fetch('{% url "appraisals:get_section_data" %}?section=D&appraisal_id={{ appraisal.appraisal_id }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);
                if (data && data.data) {
                    const formData = data.data;
                    
                    // Populate textarea fields
                    for (const [key, value] of Object.entries(formData)) {
                        // Handle text inputs, textareas and date fields
                        const field = document.querySelector(`input[type="text"][name="${key}"], input[type="date"][name="${key}"], textarea[name="${key}"]`);
                        if (field && value) {
                            field.value = value;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading saved data:', error);
            });
    }

    function saveDraft() {
        // Create a FormData object
        const form = document.getElementById('section-d-form');
        if (!form) {
            console.error("Form not found!");
            showSaveMessage('Error: Form not found', 'error');
            return;
        }
        
        const formData = new FormData(form);
        formData.append('is_draft', 'true');
        
        // Log what we're about to send
        console.log("Saving form data...");
        
        // Show the saving indicator
        const saveIndicator = document.getElementById('save-indicator');
        saveIndicator.classList.remove('htmx-indicator');
        saveIndicator.style.display = 'flex';
        
        // Use fetch API for more control
        fetch('{% url "appraisals:save_section_data" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log("Response status:", response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Server error: ${response.status} - ${text || 'No error message'}`);
                });
            }
            return response.text();
        })
        .then(data => {
            console.log('Draft saved successfully:', data);
            showSaveMessage('Draft saved successfully!');
            
            // Optionally reload the saved data to confirm it was saved
            setTimeout(() => loadSavedData(), 1000);
        })
        .catch(error => {
            console.error('Error saving draft:', error);
            showSaveMessage('Error saving draft: ' + error.message, 'error');
        })
        .finally(() => {
            // Hide the saving indicator
            saveIndicator.style.display = 'none';
            saveIndicator.classList.add('htmx-indicator');
        });
    }

    function showSaveMessage(message, type = 'success') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
        toast.className = `fixed bottom-4 left-4 ${bgColor} px-4 py-3 rounded z-50 border`;
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>

<meta name="csrf-token" content="{{ csrf_token }}">

<script src="{% static 'appraisals/js/appraisal-batch-save.js' %}"></script>

<form id="section-d-form" method="post" action="">
    {% csrf_token %}
    {{ wizard.management_form}}
    <input type="hidden" name="appraisal_id" value="{{ appraisal.appraisal_id }}">
    <input type="hidden" name="section" value="D">

<!-- Appraisal Wizard Section D -->
<div class="max-w-5xl mx-auto bg-white shadow-md rounded-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Section D: Certification of Adverse Appraisal</h2>
    <p class="text-sm text-gray-600 mb-6 pb-2 border-b border-gray-200">
        This Section is to be completed by the appraiser if he has made an adverse comment in respect of any paragraph given in sections B and C
    </p>

    <!-- D1. Adverse Comment Certification -->
    <div class="mb-8 bg-gray-50 rounded-lg shadow-sm p-5 border border-gray-100">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">Certification</h3>
        
        <div class="mb-6">
            <p class="text-gray-700 mb-4 font-medium">
                This is to certify that I have drawn the appraisee's attention to my adverse comments mentioned in paragraph(s)
            </p>
            <input type="text" 
                   class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" 
                   id="d_adverse_paragraphs" 
                   name="d_adverse_paragraphs" 
                   placeholder="e.g. B2, B5, C1"
                   >
            <p class="text-gray-700 mt-2">of section B and C</p>
        </div>
    </div>

    <!-- Date -->
    <div class="mb-8 bg-gray-50 rounded-lg shadow-sm p-5 border border-gray-100">
        <div class="form-group">
            <label for="d_certification_date" class="block text-sm font-medium text-gray-700 mb-1">
                Date
            </label>
            <input type="date" 
                   class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   id="d_certification_date" 
                   name="d_certification_date" 
                   >
        </div>
    </div>

    <!-- Save indicator -->
    <div id="save-indicator" class="htmx-indicator fixed bottom-4 right-4 p-3 bg-white rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <svg class="animate-spin h-5 w-5 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700">Saving...</span>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
        <!-- Previous button -->
        <button type="submit" 
                name="wizard_goto_step" 
                value="{{ wizard.steps.prev }}" 
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors">
            <span class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Previous
            </span>
        </button>


        <!-- Save as Draft Button -->
        <button type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-green-500 transition-colors"
                id="save-draft-button"
                onclick="saveDraft()">
            <span class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                </svg>
                Save as Draft
            </span>
        </button>
        
        <div id="nav-indicator" class="htmx-indicator">
            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        
        <!-- Next button -->
        <button type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            <span class="flex items-center">
                Next
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </span>
        </button>
    </div>
</div>
</form>
</div>
{% endblock %}